<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liosdoire MPS Quote v9 — Margin Guard</title>
    <style>
        :root { --primary: #1e3a8a; --success: #16a34a; --warning: #d97706; --danger: #dc2626; --light: #f8fafc; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { background: var(--light); color: #1e293b; padding: 16px; max-width: 900px; margin: 0 auto; }
        
        header { text-align: center; padding: 20px 0; border-bottom: 2px solid #e2e8f0; }
        .subtitle { color: #64748b; font-size: 0.9rem; }
        
        .section { background: white; border-radius: 12px; padding: 20px; margin: 16px 0; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .section-title { font-size: 1.25rem; font-weight: 600; color: var(--primary); margin-bottom: 4px; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; }
        .section-desc { font-size: 0.85rem; color: #64748b; margin-bottom: 16px; font-style: italic; }

        /* DEVICE LIST */
        .device-grid { display: grid; gap: 12px; }
        .device-item { 
            display: flex; align-items: center; padding: 12px; 
            border: 1px solid #e2e8f0; border-radius: 8px; transition: 0.2s; 
        }
        .device-item:hover { border-color: var(--primary); background: #f0f9ff; }
        .device-info { flex: 1; }
        .device-name { font-weight: 700; color: #1e293b; }
        .device-financials { font-size: 0.85rem; color: #64748b; margin-top: 4px; }
        .device-allowance { 
            font-size: 0.8rem; font-weight: 600; color: var(--success); 
            background: #dcfce7; padding: 2px 8px; border-radius: 4px; 
            display: inline-block; margin-top: 4px;
        }
        .device-allowance.low { color: var(--danger); background: #fee2e2; }

        /* CONTROLS */
        .qty-controls { display: flex; align-items: center; gap: 8px; }
        button { background: var(--primary); color: white; border: none; border-radius: 6px; padding: 10px 16px; font-weight: 600; cursor: pointer; }
        button:disabled { opacity: 0.5; cursor: not-allowed; background: #94a3b8; }
        button.secondary { background: #64748b; }
        button.success { background: var(--success); }
        input, select { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 1rem; width: 100%; }
        
        /* VALIDATION STYLES */
        input.error { border: 2px solid var(--danger); background: #fef2f2; }
        .validation-msg { color: var(--danger); font-size: 0.85rem; font-weight: 600; margin-top: 6px; display: none; }
        .validation-msg.visible { display: block; }

        /* RESULTS TABLE */
        .result { background: #f1f5f9; border-radius: 8px; padding: 20px; margin-top: 16px; }
        .result-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
        .result-table th, .result-table td { text-align: left; padding: 10px 12px; border-bottom: 1px solid #cbd5e1; }
        .result-table th { background: #e2e8f0; font-weight: 600; }
        .result-total { font-weight: 700; font-size: 1.1rem; color: var(--primary); border-top: 2px solid #cbd5e1; padding-top: 12px; }
        
        .client-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        label { display: block; margin: 4px 0; font-weight: 500; font-size: 0.9rem; }
        .source-note { font-size: 0.75rem; color: #94a3b8; margin-top: 8px; }
        .hidden { display: none; }
        .alert { padding: 12px; margin: 16px 0; border-radius: 8px; text-align: center; font-weight: bold;}
        .alert-error { background: #fee2e2; color: var(--danger); border: 1px solid #fca5a5; }
        .alert-success { background: #dcfce7; color: var(--success); border: 1px solid #86efac; }

        @media (max-width: 600px) {
            .client-info-grid { grid-template-columns: 1fr; }
            .device-item { flex-direction: column; align-items: flex-start; }
            .qty-controls { width: 100%; justify-content: space-between; margin-top: 10px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="subtitle">
            <img src="https://liosdoirecomputers.com/wp-content/uploads/2023/01/LiosdoireComputerslogo-o8.png" width="120" alt="Liosdoire Logo">
        </div>
        <br><strong>Liosdoire Computers - Smart Quote v9</strong>
    </header>

    <div id="app">
        <div class="section">
            <div class="section-title">1. Client Information</div>
            <div class="client-info-grid">
                <div>
                    <label>Client Name *</label>
                    <input type="text" id="clientName" placeholder="e.g. St. Brendan's School" required>
                </div>
                <div>
                    <label>Email *</label>
                    <input type="email" id="clientEmail" placeholder="admin@school.ie" required>
                </div>
                <div>
                    <label>Phone</label>
                    <input type="tel" id="clientPhone" placeholder="08x xxx xxxx">
                </div>
                <div>
                    <label>Sector *</label>
                    <select id="clientSector" required>
                        <option value="">Select...</option>
                        <option value="Education">Education</option>
                        <option value="Business">Business</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">2. Select Devices</div>
            <div class="section-desc">
                Suggested Print Volumes are calculated to strictly maintain a 50% profit margin on each unit.
            </div>
            <div class="device-grid" id="deviceList">
                </div>
        </div>

        <div class="section">
            <div class="section-title">3. Managed Print (Optional)</div>
            <div>
                <label>
                    <input type="checkbox" id="mpsToggle"> 
                    Include Cloud Management / Support Pack?
                </label>
            </div>
            <div id="mpsOptions" class="hidden">
                <div style="margin: 16px 0;">
                    <label>Select Pack:</label>
                    <select id="packSelect" style="margin-top: 4px;">
                        <option value="Basic">RSI Basic — €20/mo (Cloud Mgmt)</option>
                        <option value="Plus">RSI Plus — €35/mo (+Scan/Storage)</option>
                        <option value="Platinum">RSI Platinum — €45/mo (+Priority)</option>
                    </select>
                </div>
                <div>
                    <label>Quantity:</label>
                    <input type="number" id="mpsMachines" min="1" value="1">
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">4. Print Credit Allocation</div>
            <div class="section-desc">
                Defaults are auto-calculated based on the 50% margin limit of selected devices.
            </div>
            
            <div style="margin-bottom: 16px;">
                <label><strong>Included Print Credit (60 Months):</strong></label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 8px;">
                    <div>
                        <label style="font-size:0.8rem">Mono Pages</label>
                        <input type="number" id="monoIncluded" value="0">
                    </div>
                    <div>
                        <label style="font-size:0.8rem">Colour Pages</label>
                        <input type="number" id="colourIncluded" value="0">
                    </div>
                </div>
                <div id="creditWarning" class="validation-msg">
                    ⚠️ Error: These credits exceed the 50% margin safety limit. Please reduce volume or choose higher margin devices.
                </div>
                <div id="creditInfo" class="source-note" style="color: var(--success); font-weight: bold;">
                    ✅ Current allocation is within safety margin.
                </div>
            </div>

            <div class="excess-section" style="background: #f0f9ff; padding: 15px; border-radius: 6px;">
                <label><strong>Excess Rates (Pay-per-print):</strong></label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 8px;">
                    <div><input type="number" id="monoExcess" placeholder="Est. Excess Mono/Year"></div>
                    <div><input type="number" id="colourExcess" placeholder="Est. Excess Colour/Year"></div>
                </div>
                <div class="source-note">Rates: €0.005 Mono / €0.05 Colour</div>
            </div>
        </div>

        <div style="margin-bottom: 16px; padding: 0 20px;">
            <label>Grenke Finance Rate:</label>
            <select id="grenkeRate">
                <option value="3.5">3.5% (Best Case)</option>
                <option value="4.0">4.0% (Standard)</option>
                <option value="5.0" selected>5.0% (Safe)</option>
            </select>
        </div>

        <div class="section">
            <div class="section-title">5. Quote Summary</div>
            <button id="calculateBtn" class="success">Calculate Full Quote</button>
            <div id="alertBox" class="hidden alert"></div>

            <div id="result" class="result hidden">
                <table class="result-table">
                    <thead><tr><th>Item</th><th>Calculation</th><th>Amount (€)</th></tr></thead>
                    <tbody>
                        <tr><td>Device Revenue (60mo)</td><td id="deviceCalc"></td><td id="deviceAmt"></td></tr>
                        <tr><td>MPS Revenue (60mo)</td><td id="mpsCalc"></td><td id="mpsAmt"></td></tr>
                        <tr style="background:#e0f2fe"><td><strong>Gross Contract Value</strong></td><td></td><td id="revenueAmt"></td></tr>
                        <tr><td>Less: Grenke Fee</td><td><span id="grenkePct"></span>% Haircut</td><td id="grenkeAmt" style="color:red"></td></tr>
                        <tr><td>Less: Hardware CapEx</td><td id="capexCalc"></td><td id="capexAmt" style="color:red"></td></tr>
                        <tr><td>Less: Service/Toner Cost</td><td id="cppCalc"></td><td id="cppAmt" style="color:red"></td></tr>
                        <tr style="background:#dcfce7"><td><strong>Net Profit (Cash)</strong></td><td></td><td id="profitAmt" style="font-weight:bold"></td></tr>
                        <tr><td>Net Margin</td><td>Target: >50%</td><td id="marginAmt" style="font-weight:bold"></td></tr>
                    </tbody>
                </table>
                
                <div style="margin-top:20px; text-align:right;">
                    <div style="font-size:1.2rem; color:var(--primary);"><strong>Monthly (Ex VAT): <span id="monthlyDisplay">€0.00</span></strong></div>
                    <div style="font-size:1rem; color:#64748b;">Inc VAT (23%): <span id="monthlyVatDisplay">€0.00</span></div>
                </div>
            </div>
            
            <button id="emailBtn" class="secondary hidden" style="margin-top: 15px;">Send Quote to Office</button>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const MARGIN_TARGET = 0.50; // 50% Margin Required
        const RICOH_CPP = { mono: 0.0038, colour: 0.038 };
        const EXCESS_RATES = { mono: 0.005, colour: 0.05 };
        
        // Device Database
        const DEVICES = [
            { model: "Ricoh IM 7000", desc: "Ricoh IM 7000 (A3 Mono)", cost: 300.00, capex: 4150 },
            { model: "Ricoh IM C3010", desc: "Ricoh IM C3010 (A3 Colour)", cost: 150.00, capex: 2000 },
            { model: "Ricoh IM C320F", desc: "Ricoh IM C320F (A4 Colour)", cost: 50.00, capex: 1000 },
            { model: "Ricoh IM 370", desc: "Ricoh IM 370 (A4 Mono)", cost: 25.00, capex: 700 },
            { model: "Ricoh IM 3000", desc: "Ricoh IM 3000 (A3 Mono)", cost: 100.00, capex: 1710 }
        ];

        const PACKS = { Basic: 20.00, Plus: 35.00, Platinum: 45.00 };

        // --- 2. LOGIC: SAFETY CALCULATOR ---
        
        // Calculates how much service money is available per device while keeping 50% margin
        function getDeviceServiceBudget(device) {
            const revenue = device.cost * 60; 
            const requiredMargin = revenue * MARGIN_TARGET;
            // Available = Revenue - Capex - 50% Profit
            const budget = revenue - device.capex - requiredMargin;
            return Math.max(0, budget);
        }

        // Generates the "Suggested Volume" text for the UI
        function getSuggestionText(device) {
            const budget = getDeviceServiceBudget(device);
            if (budget <= 0) return { text: "⚠️ Low Margin Device - No Credit Allowed", class: "low" };

            // Logic: If Colour, assume 85% Mono / 15% Colour mix for the suggestion
            if (device.desc.includes("Colour")) {
                const compositeCost = (0.85 * RICOH_CPP.mono) + (0.15 * RICOH_CPP.colour); // ~0.0089
                const pages = Math.floor(budget / compositeCost);
                return { text: `Safe Vol: ~${pages.toLocaleString()} (Mixed)`, class: "" };
            } else {
                const pages = Math.floor(budget / RICOH_CPP.mono);
                return { text: `Safe Vol: ~${pages.toLocaleString()} (Mono)`, class: "" };
            }
        }

        // --- 3. UI RENDERING & EVENTS ---

        function init() {
            const list = document.getElementById('deviceList');
            list.innerHTML = DEVICES.map((d, index) => {
                const safeModel = d.model.replace(/\s+/g, '_');
                const suggestion = getSuggestionText(d);
                return `
                <div class="device-item">
                    <div class="device-info">
                        <div class="device-name">${d.desc}</div>
                        <div class="device-financials">Cost: €${d.cost}/mo | CapEx: €${d.capex}</div>
                        <div class="device-allowance ${suggestion.class}">${suggestion.text}</div>
                    </div>
                    <div class="qty-controls">
                        <button onclick="adjustQty('${safeModel}', -1)">-</button>
                        <input type="number" id="qty-${safeModel}" value="0" readonly style="width:50px; text-align:center; background:#f1f5f9;">
                        <button onclick="adjustQty('${safeModel}', 1)">+</button>
                    </div>
                </div>`;
            }).join('');

            // Listeners
            document.getElementById('mpsToggle').addEventListener('change', (e) => {
                document.getElementById('mpsOptions').classList.toggle('hidden', !e.target.checked);
            });
            
            // Real-time Validation on manual input
            document.getElementById('monoIncluded').addEventListener('input', validateSafetyMargin);
            document.getElementById('colourIncluded').addEventListener('input', validateSafetyMargin);

            document.getElementById('calculateBtn').addEventListener('click', calculateQuote);
        }

        function adjustQty(modelSafe, delta) {
            const el = document.getElementById(`qty-${modelSafe}`);
            let val = parseInt(el.value) || 0;
            val = Math.max(0, val + delta);
            el.value = val;
            
            // AUTO-UPDATE DEFAULTS
            recalculateDefaults();
        }

        function getQty(model) {
            const safe = model.replace(/\s+/g, '_');
            return parseInt(document.getElementById(`qty-${safe}`).value) || 0;
        }

        // --- 4. CORE LOGIC: AUTO-POPULATE & VALIDATE ---

        function recalculateDefaults() {
            let totalMonoPages = 0;
            let totalColourPages = 0;

            DEVICES.forEach(d => {
                const qty = getQty(d.model);
                if (qty > 0) {
                    const budget = getDeviceServiceBudget(d); // Total € available for service
                    
                    if (d.desc.includes("Colour")) {
                        // For Colour machines, split the safe budget: 85% to Mono pool, 15% to Colour pool
                        // Note: This is a safe "Default" distribution
                        const compositeCost = (0.85 * RICOH_CPP.mono) + (0.15 * RICOH_CPP.colour);
                        const totalSafePages = budget / compositeCost;
                        
                        totalMonoPages += (totalSafePages * 0.85) * qty;
                        totalColourPages += (totalSafePages * 0.15) * qty;
                    } else {
                        // For Mono machines, 100% to Mono pool
                        totalMonoPages += (budget / RICOH_CPP.mono) * qty;
                    }
                }
            });

            // Update Inputs
            document.getElementById('monoIncluded').value = Math.floor(totalMonoPages);
            document.getElementById('colourIncluded').value = Math.floor(totalColourPages);
            
            validateSafetyMargin();
        }

        function validateSafetyMargin() {
            // 1. Calculate Total Allowed Service Budget (The 50% Limit)
            let maxServiceBudget = 0;
            DEVICES.forEach(d => {
                maxServiceBudget += getDeviceServiceBudget(d) * getQty(d.model);
            });

            // 2. Calculate Cost of User Inputs
            const userMono = parseInt(document.getElementById('monoIncluded').value) || 0;
            const userColour = parseInt(document.getElementById('colourIncluded').value) || 0;
            const currentServiceCost = (userMono * RICOH_CPP.mono) + (userColour * RICOH_CPP.colour);

            // 3. Compare
            const warningEl = document.getElementById('creditWarning');
            const infoEl = document.getElementById('creditInfo');
            const calcBtn = document.getElementById('calculateBtn');
            const mInput = document.getElementById('monoIncluded');
            const cInput = document.getElementById('colourIncluded');

            if (currentServiceCost > maxServiceBudget + 1) { // +1 for rounding tolerance
                // FAIL
                warningEl.classList.add('visible');
                infoEl.classList.add('hidden');
                mInput.classList.add('error');
                cInput.classList.add('error');
                calcBtn.disabled = true;
                calcBtn.textContent = "⚠️ Margin Safety Violation";
            } else {
                // PASS
                warningEl.classList.remove('visible');
                infoEl.classList.remove('hidden');
                mInput.classList.remove('error');
                cInput.classList.remove('error');
                calcBtn.disabled = false;
                calcBtn.textContent = "Calculate Full Quote";
            }
        }

        // --- 5. CALCULATE FINAL QUOTE ---

        function calculateQuote() {
            // Inputs
            const clientName = document.getElementById('clientName').value;
            if(!clientName) { alert("Please enter Client Name"); return; }
            
            const grenkeRate = parseFloat(document.getElementById('grenkeRate').value) / 100;
            
            // Device Totals
            let deviceMonthly = 0;
            let capexTotal = 0;
            let quantities = {};
            
            DEVICES.forEach(d => {
                const qty = getQty(d.model);
                if(qty > 0) {
                    quantities[d.model] = qty;
                    deviceMonthly += qty * d.cost;
                    capexTotal += qty * d.capex;
                }
            });

            if (deviceMonthly === 0) { alert("Select at least one device"); return; }

            // MPS
            let mpsMonthly = 0;
            if(document.getElementById('mpsToggle').checked) {
                const packCost = PACKS[document.getElementById('packSelect').value];
                const qty = parseInt(document.getElementById('mpsMachines').value) || 0;
                mpsMonthly = qty * packCost;
            }

            // Totals
            const totalMonthly = deviceMonthly + mpsMonthly;
            const grossContractVal = totalMonthly * 60;
            const grenkeFee = grossContractVal * grenkeRate;
            const cashInBank = grossContractVal - grenkeFee;

            // Service Cost
            const monoInc = parseInt(document.getElementById('monoIncluded').value) || 0;
            const colInc = parseInt(document.getElementById('colourIncluded').value) || 0;
            const serviceCost = (monoInc * RICOH_CPP.mono) + (colInc * RICOH_CPP.colour);

            // Profit
            const netProfit = cashInBank - capexTotal - serviceCost;
            const margin = (netProfit / cashInBank) * 100;

            // Render
            document.getElementById('deviceCalc').textContent = `€${deviceMonthly.toFixed(2)}/mo × 60`;
            document.getElementById('deviceAmt').textContent = `€${(deviceMonthly*60).toFixed(2)}`;
            document.getElementById('mpsCalc').textContent = `€${mpsMonthly.toFixed(2)}/mo × 60`;
            document.getElementById('mpsAmt').textContent = `€${(mpsMonthly*60).toFixed(2)}`;
            document.getElementById('revenueAmt').textContent = `€${grossContractVal.toFixed(2)}`;
            
            document.getElementById('grenkePct').textContent = (grenkeRate*100).toFixed(1);
            document.getElementById('grenkeAmt').textContent = `-€${grenkeFee.toFixed(2)}`;
            
            document.getElementById('capexCalc').textContent = `Hardware Cost`;
            document.getElementById('capexAmt').textContent = `-€${capexTotal.toFixed(2)}`;
            
            document.getElementById('cppCalc').textContent = `${monoInc}m / ${colInc}c`;
            document.getElementById('cppAmt').textContent = `-€${serviceCost.toFixed(2)}`;
            
            document.getElementById('profitAmt').textContent = `€${netProfit.toFixed(2)}`;
            
            const marginEl = document.getElementById('marginAmt');
            marginEl.textContent = `${margin.toFixed(1)}%`;
            marginEl.style.color = margin >= 50 ? 'green' : 'red';

            document.getElementById('monthlyDisplay').textContent = `€${totalMonthly.toFixed(2)}`;
            document.getElementById('monthlyVatDisplay').textContent = `€${(totalMonthly*1.23).toFixed(2)}`;

            document.getElementById('result').classList.remove('hidden');
        }

        // Start
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
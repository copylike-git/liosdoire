<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liosdoire MPS Quote ‚Äî Preview</title>
    <style>
        :root { --primary: #1e3a8a; --light: #f8fafc; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: Arial, sans-serif; }
        body { background: var(--light); color: #1e293b; padding: 16px; }
        .container { max-width: 800px; margin: 0 auto; }
        header { text-align: center; padding: 20px 0; border-bottom: 2px solid #e2e8f0; }
        h1 { font-size: 1.4rem; margin: 8px 0; }
        .subtitle { color: #64748b; font-size: 0.9rem; }
        .pdf-page { background: white; padding: 40px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .section { margin-bottom: 24px; }
        .section-title { font-weight: bold; margin-bottom: 8px; }
        table { width: 100%; border-collapse: collapse; margin: 12px 0; }
        th, td { text-align: left; padding: 8px 4px; border-bottom: 1px solid #e2e8f0; }
        .footer { text-align: center; margin-top: 30px; color: #64748b; font-size: 0.85rem; }
        .btn { background: var(--primary); color: white; border: none; border-radius: 6px; padding: 12px 24px; font-size: 1rem; cursor: pointer; margin-top: 20px; }
        .btn:hover { opacity: 0.9; }
        .hidden { display: none; }
        @media print {
            .btn, footer { display: none; }
            .pdf-page { box-shadow: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Managed Print Solution Agreement</h1>
            <div class="subtitle">Liosdoire Computers ‚Äî Preview Before Sending</div>
        </header>

        <!-- Page 1 -->
        <div class="pdf-page">
            <div class="section">
                <div><strong>Company / School:</strong> <span id="previewClientName">Client Name</span></div>
                <div><strong>Date:</strong> <span id="previewDate">DD/MM/YYYY</span></div>
                <div><strong>Address:</strong> <span id="previewAddress">‚Äî</span></div>
                <div><strong>Rep:</strong> S. Linnane</div>
                <div><strong>Client Name:</strong> <span id="previewClientContact">‚Äî</span></div>
                <div><strong>Client email:</strong> <span id="previewClientEmail">‚Äî</span></div>
                <div><strong>Type:</strong> <span id="previewClientSector">Education</span></div>
            </div>

            <div class="section">
                <div class="section-title">Copier choice</div>
                <table>
                    <thead>
                        <tr>
                            <th>Quantity</th>
                            <th>Model (All MFP with scanner)</th>
                            <th>Speed</th>
                            <th>Annual load</th>
                            <th>Monthly Load</th>
                            <th>Cost/month</th>
                        </tr>
                    </thead>
                    <tbody id="previewDeviceTable">
                        <!-- Filled by JS -->
                    </tbody>
                </table>
            </div>

            <div class="section">
                <div class="section-title">Print Management included</div>
                <table>
                    <tr>
                        <td>YES / NO</td>
                        <td>Cloud Print management and user accounting per machine</td>
                        <td>‚Ç¨<span id="previewMgmtFee">20.00</span></td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Page 2 -->
        <div class="pdf-page">
            <div class="section">
                <div class="section-title">Proposal</div>
                <div>Photocopier maintenance and print management plan ‚Äî Cost per month</div>
                <div><strong>Agreement Print credit (Usable over 60 months)</strong></div>
                <div>120,000 mono & 30,000 colour ‚Äî <strong>INCLUDED</strong></div>
                <div>Mono & colour Toner when required</div>
                <div>Replacement Imaging Unit & Drums when required</div>
                <div>Maintenance parts & labour</div>
                <div><em>Fair Deal</em></div>
            </div>

            <div class="section">
                <div>Print counter is calculated for usage over 60 months, allowing our client to better leverage their busier and off-peak printing needs.</div>
                <div>We will be monitoring your usage to ensure you are working within budget.</div>
                <div>We believe a ‚ÄúFair deal‚Äù is a good deal for all.</div>
            </div>

            <div class="section">
                <div class="section-title">Additional cost (excess use only)</div>
                <table>
                    <tr><td>Colour Prints/Copies</td><td>‚Ç¨0.05</td></tr>
                    <tr><td>Mono Prints/Copies</td><td>‚Ç¨0.005</td></tr>
                </table>
                <div><em>All prices are ex. VAT 23%</em></div>
            </div>

            <div class="section">
                <div><strong>Monthly Total (ex. VAT):</strong> ‚Ç¨<span id="previewMonthlyExVat">0.00</span></div>
                <div><strong>Monthly Total (inc. VAT):</strong> ‚Ç¨<span id="previewMonthlyIncVat">0.00</span></div>
            </div>
        </div>

        <button id="sendBtn" class="btn">üì§ Send to itetralee@gmail.com</button>
        <div id="alertBox" class="hidden" style="margin-top: 16px; padding: 12px; background: #dcfce7; border-radius: 6px;"></div>

        <div class="footer">
            Liosdoire Computers ‚Äî Based on 2026 Ricoh Order.pdf
        </div>
    </div>

    <script>
        // Reconstruct quote from session (set by main quoting tool)
        document.addEventListener('DOMContentLoaded', () => {
            const data = JSON.parse(sessionStorage.getItem('quoteData'));
            if (!data) {
                alert("No quote data found. Please calculate first.");
                window.history.back();
                return;
            }

            // Page 1
            document.getElementById('previewClientName').textContent = data.clientName;
            document.getElementById('previewDate').textContent = new Date().toLocaleDateString('en-IE');
            document.getElementById('previewClientContact').textContent = data.clientName;
            document.getElementById('previewClientEmail').textContent = data.clientEmail;
            document.getElementById('previewClientSector').textContent = data.clientSector;

            // Devices
            const deviceRows = [];
            const ricohSpecs = {
                "Ricoh IM 7000": { speed: "70 ppm", annual: "700,000", monthly: "40,000‚Äì100,000", cost: 300.00 },
                "Ricoh IM C3010": { speed: "30 ppm", annual: "200,000", monthly: "8,000‚Äì25,000", cost: 150.00 },
                "Ricoh IM C320F": { speed: "32 ppm", annual: "75,000", monthly: "3,000‚Äì8,000", cost: 50.00 },
                "Ricoh IM 370": { speed: "37 ppm", annual: "120,000", monthly: "5,000‚Äì12,000", cost: 25.00 },
                "Ricoh IM 3000": { speed: "30 ppm", annual: "250,000", monthly: "10,000‚Äì30,000", cost: 100.00 }
            };

            for (const [model, qty] of Object.entries(data.quantities)) {
                if (qty > 0) {
                    const spec = ricohSpecs[model] || { speed: "‚Äî", annual: "‚Äî", monthly: "‚Äî", cost: data.deviceMonthly / Object.values(data.quantities).reduce((a, b) => a + b, 0) };
                    deviceRows.push(`
                        <tr>
                            <td>${qty}</td>
                            <td>${model.replace('Ricoh ', '')}</td>
                            <td>${spec.speed}</td>
                            <td>${spec.annual}</td>
                            <td>${spec.monthly}</td>
                            <td>‚Ç¨${(spec.cost || 0).toFixed(2)}</td>
                        </tr>
                    `);
                }
            }
            document.getElementById('previewDeviceTable').innerHTML = deviceRows.join('');

            // Management fee
            const mgmtPerMachine = data.mpsMachinesVal > 0 ? 20 : 0;
            document.getElementById('previewMgmtFee').textContent = mgmtPerMachine.toFixed(2);

            // Page 2 totals
            document.getElementById('previewMonthlyExVat').textContent = data.totalMonthlyExVat.toFixed(2);
            document.getElementById('previewMonthlyIncVat').textContent = (data.totalMonthlyExVat * 1.23).toFixed(2);

            // Send button
            document.getElementById('sendBtn').addEventListener('click', sendQuote);
        });

        function sendQuote() {
            const data = JSON.parse(sessionStorage.getItem('quoteData'));
            if (!data) return;

            const quoteText = `
Liosdoire MPS Quote ‚Äî Client Preview

Client: ${data.clientName} (${data.clientSector})
Email: ${data.clientEmail}
Phone: ${data.clientPhone || "‚Äî"}

=== SELECTED DEVICES ===
${Object.entries(data.quantities)
    .map(([model, qty]) => qty > 0 ? `- ${qty} √ó ${model}` : '')
    .filter(x => x).join('\n')}

=== PRINT CREDIT ===
120,000 mono + 30,000 colour over 60 months (per site)

=== MONTHLY COST (ex. VAT) ===
Device Fees: ‚Ç¨${data.deviceMonthly.toFixed(2)}
Cloud Management (${data.mpsMachinesVal} √ó ‚Ç¨20): ‚Ç¨${(data.mpsMachinesVal * 20).toFixed(2)}
MPS Pack (${data.packName}): ‚Ç¨${data.mpsMonthly.toFixed(2)}
‚Üí TOTAL (ex. VAT): ‚Ç¨${data.totalMonthlyExVat.toFixed(2)}
‚Üí TOTAL (inc. VAT): ‚Ç¨${(data.totalMonthlyExVat * 1.23).toFixed(2)}

Excess: ‚Ç¨0.005 mono / ‚Ç¨0.05 colour

Generated: ${new Date().toLocaleString()}
            `.trim();

            fetch('https://formspree.io/f/xdannjrl', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    _replyto: data.clientEmail,
                    _to: 'itetralee@gmail.com',
                    subject: `MPS Quote Preview ‚Äî ${data.clientName}`,
                    message: quoteText
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    const alert = document.getElementById('alertBox');
                    alert.textContent = "‚úÖ Quote sent successfully to itetralee@gmail.com";
                    alert.classList.remove('hidden');
                } else {
                    throw new Error();
                }
            })
            .catch(() => {
                alert("‚ùå Failed to send. Please try again.");
            });
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liosdoire Quote v15.4 â€” Detailed Analysis</title>
    <style>
        :root { --primary: #1e3a8a; --success: #16a34a; --warning: #d97706; --danger: #dc2626; --light: #f8fafc; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { background: var(--light); color: #1e293b; padding: 16px; max-width: 900px; margin: 0 auto; }
        
        header { text-align: center; padding: 20px 0; border-bottom: 2px solid #e2e8f0; }
        .subtitle { color: #64748b; font-size: 0.9rem; }
        
        .section { background: white; border-radius: 12px; padding: 20px; margin: 16px 0; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .section-title { font-size: 1.25rem; font-weight: 600; color: var(--primary); margin-bottom: 4px; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; }
        .section-desc { font-size: 0.85rem; color: #64748b; margin-bottom: 16px; font-style: italic; }

        /* DEVICE LIST */
        .device-grid { display: grid; gap: 12px; }
        .device-item { display: flex; align-items: center; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; transition: 0.2s; }
        .device-item:hover { border-color: var(--primary); background: #f0f9ff; }
        .device-info { flex: 1; }
        .device-name { font-weight: 700; color: #1e293b; }
        .device-financials { font-size: 0.85rem; color: #64748b; margin-top: 4px; }
        
        /* CONTROLS */
        .qty-controls { display: flex; align-items: center; gap: 8px; }
        button { background: var(--primary); color: white; border: none; border-radius: 6px; padding: 10px 16px; font-weight: 600; cursor: pointer; }
        button:disabled { opacity: 0.5; cursor: not-allowed; background: #94a3b8; }
        button.secondary { background: #64748b; }
        button.success { background: var(--success); }
        input[type="number"], select, input[type="text"], input[type="tel"], input[type="email"] { 
            padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 1rem; width: 100%; 
        }
        input[readonly] { background: #f1f5f9; color: #64748b; cursor: not-allowed; }

        /* MPS LIST */
        .mps-list { margin-top: 10px; border: 1px solid #cbd5e1; border-radius: 6px; overflow: hidden; }
        .mps-item { display: flex; flex-direction: column; padding: 10px; background: #fff; border-bottom: 1px solid #f1f5f9; }
        .mps-row-main { display: flex; align-items: center; width: 100%; }
        .mps-row-main label { margin: 0 0 0 10px; cursor: pointer; flex: 1; display: flex; justify-content: space-between; align-items: center; }
        .mps-unit-badge { background: #e2e8f0; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; color: #475569; }
        .mps-location-input { margin-top: 8px; margin-left: 25px; display: none; }
        .mps-location-input.visible { display: block; }
        .mps-location-input input { font-size: 0.9rem; padding: 6px; border-color: #93c5fd; background: #eff6ff; }

        /* DASHBOARD */
        .dashboard-container { display: flex; justify-content: space-between; align-items: flex-start; background: #f8fafc; padding: 20px 10px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .control-group { display: flex; flex-direction: column; align-items: center; width: 23%; min-width: 140px; background: #fff; padding: 15px 5px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .slider-wrapper { height: 200px; display: flex; justify-content: center; align-items: center; margin: 15px 0; width: 100%; }
        
        input[type=range][orient=vertical] { writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 12px; height: 100%; cursor: pointer; outline: none; }
        .slider-black { accent-color: #0f172a; filter: grayscale(100%); }
        .slider-rainbow { accent-color: #e11d48; }
        .slider-rainbow::-webkit-slider-runnable-track { background: linear-gradient(to top, blue, cyan, green, yellow, orange, red); border-radius: 5px; }

        .col-header { font-weight: 700; color: #1e3a8a; text-align: center; font-size: 0.85rem; margin-bottom: 5px; min-height: 35px; display: flex; align-items: center; justify-content: center; }
        .manual-input { width: 90%; text-align: center; font-weight: 700; color: #1e293b; border: 1px solid #cbd5e1; padding: 5px; border-radius: 6px; margin-top: 5px; font-size: 0.9rem; }
        .display-val { font-size: 0.8rem; color: #64748b; margin-top: 4px; font-weight: 600; }
        .tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: 600; text-transform: uppercase; margin-bottom: 8px; }
        .tag-blue { background: #dbeafe; color: #1e3a8a; }
        .tag-green { background: #dcfce7; color: #166534; }

        .live-total-box { background: #e0f2fe; border: 1px solid #7dd3fc; border-radius: 8px; padding: 20px; text-align: center; margin-top: 20px; }
        .live-label { color: #0369a1; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.9rem; }
        .live-amount { color: #0c4a6e; font-weight: 800; font-size: 2rem; display: block; margin-top: 5px; }

        /* RESULTS TABLE - Detailed */
        .result { background: #f1f5f9; border-radius: 8px; padding: 20px; margin-top: 16px; }
        .result-table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 0.9rem; }
        .result-table th, .result-table td { text-align: left; padding: 10px 12px; border-bottom: 1px solid #cbd5e1; vertical-align: top; }
        .result-table th { background: #e2e8f0; font-weight: 600; }
        .calc-detail { font-size: 0.75rem; color: #64748b; display: block; margin-top: 4px; font-family: monospace; }
        
        .client-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .hidden { display: none; }

        @media (max-width: 600px) {
            .client-info-grid { grid-template-columns: 1fr; }
            .dashboard-container { flex-direction: row; flex-wrap: wrap; }
            .control-group { width: 45%; margin-bottom: 10px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="subtitle">
            <img src="https://liosdoirecomputers.com/wp-content/uploads/2023/01/LiosdoireComputerslogo-o8.png" width="120" alt="Liosdoire Logo">
        </div>
        <br><strong>Liosdoire Computers - Quote v15.4</strong>
    </header>

    <div id="app">
        <div class="section">
            <div class="section-title">1. Client Information</div>
            <div class="client-info-grid">
                <div><label>Client Name</label><input type="text" id="clientName" placeholder="e.g. St. Brendan's School"></div>
                <div><label>Email</label><input type="email" id="clientEmail" placeholder="admin@school.ie"></div>
                <div><label>Phone</label><input type="tel" id="clientPhone" placeholder="08x xxx xxxx"></div>
                <div><label>Sector</label><select id="clientSector">
                    <option value="">Select...</option><option value="Education">Education</option><option value="Business">Business</option>
                </select></div>
                
                <div style="grid-column: span 2;">
                    <label style="color:var(--primary);"><strong>Grenke Finance Rate (Internal):</strong></label>
                    <select id="grenkeRate" style="border: 2px solid #cbd5e1; background-color: #f8fafc;">
                        <option value="0">0% (Direct/Cash)</option>
                        <option value="1.5">1.5% (Promo)</option>
                        <option value="3.0">3.0% (Standard)</option>
                        <option value="4.5" selected>4.5% (Safe/High Risk)</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">2. Select Devices</div>
            <div class="device-grid" id="deviceList"></div>
        </div>

        <div class="section">
            <div class="section-title">3. Managed Print (Per Unit)</div>
            <div style="margin: 16px 0;">
                <label>Select Pack Level (â‚¬20 Basic):</label>
                <select id="packSelect" style="margin-top: 4px;">
                    <option value="Basic">RSI Basic â€” â‚¬20/mo</option>
                    <option value="Plus">RSI Plus â€” â‚¬35/mo</option>
                    <option value="Platinum">RSI Platinum â€” â‚¬45/mo</option>
                </select>
            </div>
            <div id="mpsDeviceContainer" class="mps-list">
                <div style="padding:15px; color:#64748b; text-align:center;">No devices selected in Section 2.</div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">4. Print Credit Dashboard</div>
            
            <div class="dashboard-container">
                <div class="control-group" style="background:#f8fafc; border-color:#94a3b8;">
                    <span class="tag tag-blue">Hardware Included</span>
                    <div class="col-header">Included<br>Mono</div>
                    <div class="slider-wrapper">
                        <input type="range" id="sliderBaseMono" class="slider-black" orient="vertical" min="0" max="1000" step="1000" value="0">
                    </div>
                    <input type="text" id="readBaseMono" class="manual-input" readonly style="background:#e2e8f0; color:#64748b;" value="0">
                </div>

                <div class="control-group" style="background:#f8fafc; border-color:#94a3b8;">
                    <span class="tag tag-blue">Hardware Included</span>
                    <div class="col-header">Included<br>Colour</div>
                    <div class="slider-wrapper">
                        <input type="range" id="sliderBaseColour" class="slider-rainbow" orient="vertical" min="0" max="1000" step="1000" value="0">
                    </div>
                    <input type="text" id="readBaseColour" class="manual-input" readonly style="background:#e2e8f0; color:#64748b;" value="0">
                </div>

                <div class="control-group">
                    <span class="tag tag-green">Add-on</span>
                    <div class="col-header">Extra Mono<br>(â‚¬0.005)</div>
                    <div class="slider-wrapper">
                        <input type="range" id="sliderAddonMono" class="slider-black" orient="vertical" min="0" max="1000000" step="1000" value="0">
                    </div>
                    <input type="number" id="inputAddonMono" class="manual-input" value="0" step="1000">
                </div>

                <div class="control-group">
                    <span class="tag tag-green">Add-on</span>
                    <div class="col-header">Extra Colour<br>(â‚¬0.05)</div>
                    <div class="slider-wrapper">
                        <input type="range" id="sliderAddonColour" class="slider-rainbow" orient="vertical" min="0" max="1000000" step="1000" value="0">
                    </div>
                    <input type="number" id="inputAddonColour" class="manual-input" value="0" step="1000">
                </div>
            </div>
            
            <div style="text-align:center; padding: 10px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px;">
                <span style="color:#166534; font-weight:bold;">Total Retail Add-on Cost: <span id="addonCostDisplay" style="font-size:1.2rem">+â‚¬0.00</span> / mo</span>
            </div>

            <div class="live-total-box">
                <span class="live-label">Estimated Monthly Total (Ex VAT)</span>
                <span id="liveMonthlyDisplay" class="live-amount">â‚¬0.00</span>
            </div>
        </div>

        <div class="section">
            <div class="section-title">5. Quote Summary & Logic</div>
            <button id="calculateBtn" class="success">Show Detailed Breakdown & Profit</button>
            
            <div id="result" class="result hidden">
                <table class="result-table">
                    <thead><tr><th>Item</th><th>Dynamic Calculation Logic</th><th>Amount (â‚¬)</th></tr></thead>
                    <tbody>
                        <tr>
                            <td><strong>Total Monthly Revenue</strong></td>
                            <td><span class="calc-detail">Sum of Hardware + MPS + Add-on</span></td>
                            <td id="totalMonthlyAmt" style="font-weight:bold; color:var(--primary)"></td>
                        </tr>
                        <tr>
                            <td>&nbsp;&nbsp;â†³ Hardware Lease</td>
                            <td><span class="calc-detail">Device Monthly Ã— Qty</span></td>
                            <td id="deviceAmt"></td>
                        </tr>
                        <tr>
                            <td>&nbsp;&nbsp;â†³ MPS Pack</td>
                            <td><span class="calc-detail">Pack Cost Ã— Active Units</span></td>
                            <td id="mpsAmt"></td>
                        </tr>
                        <tr>
                            <td>&nbsp;&nbsp;â†³ Retail Add-on</td>
                            <td><span class="calc-detail">(Mono Ã— â‚¬0.005 + Col Ã— â‚¬0.05) / 60</span></td>
                            <td id="retailAddonAmt"></td>
                        </tr>

                        <tr style="border-top: 2px solid #cbd5e1;">
                            <td><strong>Less: Direct Costs</strong></td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>&nbsp;&nbsp;â†³ Grenke Finance Fee</td>
                            <td><span id="grenkeLogic" class="calc-detail"></span></td>
                            <td id="grenkeAmt" style="color:red"></td>
                        </tr>
                        <tr>
                            <td>&nbsp;&nbsp;â†³ Hardware CapEx</td>
                            <td><span id="capexLogic" class="calc-detail">Sum of Device Purchase Costs</span></td>
                            <td id="capexAmt" style="color:red"></td>
                        </tr>
                        <tr>
                            <td>&nbsp;&nbsp;â†³ Ricoh Service (CPP)</td>
                            <td><span id="ricohLogic" class="calc-detail"></span></td>
                            <td id="ricohAmt" style="color:red"></td>
                        </tr>

                        <tr style="background:#e0f2fe; border-top: 2px solid #cbd5e1;">
                            <td><strong>Net Cash Profit</strong></td>
                            <td><span class="calc-detail">Cash Received - (CapEx + Service + Fees)</span></td>
                            <td id="profitAmt" style="font-weight:bold"></td>
                        </tr>
                        <tr>
                            <td>Net Margin %</td>
                            <td><span class="calc-detail">Profit / (Revenue Ã— 60)</span></td>
                            <td id="marginAmt" style="font-weight:bold"></td>
                        </tr>
                    </tbody>
                </table>

                <div style="margin-top:20px; text-align:right;">
                    <div style="font-size:1.2rem; color:var(--primary);"><strong>Monthly Client Bill: <span id="monthlyDisplay">â‚¬0.00</span></strong></div>
                    <div style="font-size:1rem; color:#64748b;">Inc VAT (23%): <span id="monthlyVatDisplay">â‚¬0.00</span></div>
                </div>

                <button id="previewBtn" class="secondary" style="margin-top: 15px; width: 100%;">ðŸ“„ Proceed to Order / Preview</button>
            </div>
        </div>
    </div>

    <script>
        const RICOH_CPP = { mono: 0.0038, colour: 0.038 }; 
        const RETAIL_CPP = { mono: 0.005, colour: 0.05 };  
        const MARGIN_TARGET = 0.50;

        const DEVICES = [
            { model: "Ricoh IM 7000", desc: "Ricoh IM 7000 (A3 Mono)", cost: 300.00, capex: 4150 },
            { model: "Ricoh IM C3010", desc: "Ricoh IM C3010 (A3 Colour)", cost: 150.00, capex: 2000 },
            { model: "Ricoh IM C320F", desc: "Ricoh IM C320F (A4 Colour)", cost: 50.00, capex: 1000 },
            { model: "Ricoh IM 370", desc: "Ricoh IM 370 (A4 Mono)", cost: 25.00, capex: 700 },
            { model: "Ricoh IM 3000", desc: "Ricoh IM 3000 (A3 Mono)", cost: 100.00, capex: 1710 }
        ];
        const PACKS = { Basic: 20.00, Plus: 35.00, Platinum: 45.00 };

        let safeBudget = 0; // Total â‚¬ available for Base Credit

        function init() {
            const list = document.getElementById('deviceList');
            list.innerHTML = DEVICES.map(d => {
                const safeModel = d.model.replace(/\s+/g, '_');
                return `
                <div class="device-item">
                    <div class="device-info">
                        <div class="device-name">${d.desc}</div>
                        <div class="device-financials">â‚¬${d.cost}/mo</div>
                    </div>
                    <div class="qty-controls">
                        <button onclick="adjustQty('${safeModel}', -1)">-</button>
                        <input type="number" id="qty-${safeModel}" value="0" readonly style="width:50px; text-align:center; background:#f1f5f9;">
                        <button onclick="adjustQty('${safeModel}', 1)">+</button>
                    </div>
                </div>`;
            }).join('');

            // --- LISTENERS ---
            const sBaseMono = document.getElementById('sliderBaseMono');
            const sBaseCol = document.getElementById('sliderBaseColour');

            sBaseMono.addEventListener('input', (e) => {
                const usedCost = parseInt(e.target.value) * RICOH_CPP.mono;
                const remBudget = Math.max(0, safeBudget - usedCost);
                const maxCol = Math.floor(remBudget / RICOH_CPP.colour / 1000) * 1000;
                sBaseCol.value = maxCol; 
                updateBaseDisplays();
                calculateLiveTotal();
            });

            sBaseCol.addEventListener('input', (e) => {
                const usedCost = parseInt(e.target.value) * RICOH_CPP.colour;
                const remBudget = Math.max(0, safeBudget - usedCost);
                const maxMono = Math.floor(remBudget / RICOH_CPP.mono / 1000) * 1000;
                sBaseMono.value = maxMono;
                updateBaseDisplays();
                calculateLiveTotal();
            });

            const sync = () => { updateAddonCost(); calculateLiveTotal(); };
            const ids = [['sliderAddonMono', 'inputAddonMono'], ['sliderAddonColour', 'inputAddonColour']];
            ids.forEach(([sId, iId]) => {
                const s = document.getElementById(sId), i = document.getElementById(iId);
                s.addEventListener('input', (e) => { i.value = e.target.value; sync(); });
                i.addEventListener('input', (e) => { s.value = e.target.value; sync(); });
            });

            document.getElementById('grenkeRate').addEventListener('change', calculateLiveTotal);
            document.getElementById('packSelect').addEventListener('change', calculateLiveTotal);
            document.getElementById('calculateBtn').addEventListener('click', calculateQuote);
            document.getElementById('previewBtn').addEventListener('click', goToPreview);
        }

        function adjustQty(modelSafe, delta) {
            const el = document.getElementById(`qty-${modelSafe}`);
            el.value = Math.max(0, (parseInt(el.value) || 0) + delta);
            renderMpsList();
            updateSafeBudget();
            calculateLiveTotal();
        }

        function getQty(model) {
            return parseInt(document.getElementById(`qty-${model.replace(/\s+/g, '_')}`).value) || 0;
        }

        function renderMpsList() {
            const container = document.getElementById('mpsDeviceContainer');
            const currentState = {};
            container.querySelectorAll('input').forEach(input => {
                if (input.type === 'checkbox') currentState[input.id] = input.checked;
                if (input.type === 'text') currentState[input.id] = input.value;
            });

            let html = "";
            let hasDevices = false;

            DEVICES.forEach(d => {
                const qty = getQty(d.model);
                if (qty > 0) {
                    hasDevices = true;
                    const safeModel = d.model.replace(/\s+/g, '_');
                    for (let i = 1; i <= qty; i++) {
                        const chkId = `mps-chk-${safeModel}-${i}`;
                        const locId = `mps-loc-${safeModel}-${i}`;
                        const divId = `mps-div-${safeModel}-${i}`;
                        
                        // Default to Unchecked for new
                        let isChecked = false;
                        if (currentState[chkId] !== undefined) isChecked = currentState[chkId];

                        html += `
                        <div class="mps-item">
                            <div class="mps-row-main">
                                <input type="checkbox" id="${chkId}" data-model="${d.model}" ${isChecked ? 'checked' : ''} onchange="toggleLocInput('${divId}', this); calculateLiveTotal();">
                                <label for="${chkId}"><span>${d.model}</span><span class="mps-unit-badge">Unit #${i}</span></label>
                            </div>
                            <div id="${divId}" class="mps-location-input ${isChecked ? 'visible' : ''}">
                                <input type="text" id="${locId}" placeholder="Location / Name" style="width:100%" value="${currentState[locId] || ''}">
                            </div>
                        </div>`;
                    }
                }
            });

            container.innerHTML = hasDevices ? html : '<div style="padding:15px; color:#64748b; text-align:center;">No devices selected.</div>';
        }

        window.toggleLocInput = function(divId, checkbox) {
            const div = document.getElementById(divId);
            if (checkbox.checked) div.classList.add('visible');
            else div.classList.remove('visible');
        }

        function updateSafeBudget() {
            // Recalculate safe margin based on HARDWARE REVENUE ONLY
            safeBudget = 0;
            DEVICES.forEach(d => {
                const q = getQty(d.model);
                if (q > 0) {
                    const revenue = d.cost * 60;
                    const safe = Math.max(0, revenue - d.capex - (revenue * MARGIN_TARGET));
                    safeBudget += safe * q;
                }
            });

            const sMono = document.getElementById('sliderBaseMono');
            const sCol = document.getElementById('sliderBaseColour');
            
            const maxMono = Math.floor(safeBudget / RICOH_CPP.mono / 1000) * 1000;
            const maxCol = Math.floor(safeBudget / RICOH_CPP.colour / 1000) * 1000;

            sMono.max = maxMono;
            sCol.max = maxCol;

            // Simple reset logic: try to keep current, clamp if needed
            if (parseInt(sMono.value) > maxMono) sMono.value = maxMono;
            if (parseInt(sCol.value) > maxCol) sCol.value = maxCol;
            
            updateBaseDisplays();
        }

        function updateBaseDisplays() {
            const sMono = document.getElementById('sliderBaseMono');
            const sCol = document.getElementById('sliderBaseColour');
            document.getElementById('readBaseMono').value = parseInt(sMono.value).toLocaleString();
            document.getElementById('readBaseColour').value = parseInt(sCol.value).toLocaleString();
        }

        function updateAddonCost() {
            const m = parseInt(document.getElementById('inputAddonMono').value) || 0;
            const c = parseInt(document.getElementById('inputAddonColour').value) || 0;
            const retailVal = (m * RETAIL_CPP.mono) + (c * RETAIL_CPP.colour);
            document.getElementById('addonCostDisplay').textContent = `+â‚¬${(retailVal/60).toFixed(2)}`;
        }

        function getFinancials() {
            const grenkeRatePct = parseFloat(document.getElementById('grenkeRate').value);
            const grenkeRate = grenkeRatePct / 100;
            
            let deviceMonthly = 0, capexTotal = 0;
            const quantities = {};
            DEVICES.forEach(d => {
                const qty = getQty(d.model);
                if(qty > 0) {
                    quantities[d.model] = qty;
                    deviceMonthly += qty * d.cost;
                    capexTotal += qty * d.capex;
                }
            });

            let mpsMonthly = 0;
            const packCost = PACKS[document.getElementById('packSelect').value];
            document.querySelectorAll('[id^="mps-chk-"]').forEach(chk => { if(chk.checked) mpsMonthly += packCost; });

            const addMono = parseInt(document.getElementById('inputAddonMono').value) || 0;
            const addCol = parseInt(document.getElementById('inputAddonColour').value) || 0;
            const addonRevenueTotal = (addMono * RETAIL_CPP.mono) + (addCol * RETAIL_CPP.colour);
            const addonMonthly = addonRevenueTotal / 60;

            const totalMonthly = deviceMonthly + mpsMonthly + addonMonthly;
            const grossContractVal = totalMonthly * 60;
            const grenkeFee = grossContractVal * grenkeRate;
            const cashInBank = grossContractVal - grenkeFee;

            const baseMono = parseInt(document.getElementById('sliderBaseMono').value) || 0;
            const baseCol = parseInt(document.getElementById('sliderBaseColour').value) || 0;
            const serviceCost = ((baseMono + addMono) * RICOH_CPP.mono) + ((baseCol + addCol) * RICOH_CPP.colour);
            
            const netProfit = cashInBank - capexTotal - serviceCost;
            const margin = (netProfit / (grossContractVal || 1)) * 100;

            return { 
                deviceMonthly, mpsMonthly, addonMonthly, totalMonthly, 
                grenkeFee, netProfit, margin, capexTotal, serviceCost, grossContractVal,
                baseMono, baseCol, addMono, addCol, grenkeRatePct
            };
        }

        function calculateLiveTotal() {
            const data = getFinancials();
            document.getElementById('liveMonthlyDisplay').textContent = `â‚¬${data.totalMonthly.toFixed(2)}`;
        }

        let quoteState = null;

        function calculateQuote() {
            const data = getFinancials();
            if (data.totalMonthly === 0) { alert("Please select at least one device."); return; }

            // Render Standard Totals
            document.getElementById('deviceAmt').textContent = `â‚¬${data.deviceMonthly.toFixed(2)}`;
            document.getElementById('mpsAmt').textContent = `â‚¬${data.mpsMonthly.toFixed(2)}`;
            document.getElementById('retailAddonAmt').textContent = `â‚¬${data.addonMonthly.toFixed(2)}`;
            document.getElementById('totalMonthlyAmt').textContent = `â‚¬${data.totalMonthly.toFixed(2)}`;
            
            // Render Detailed Breakdown Logic
            document.getElementById('grenkeLogic').textContent = `Gross â‚¬${data.grossContractVal.toFixed(0)} Ã— ${data.grenkeRatePct}%`;
            document.getElementById('grenkeAmt').textContent = `-â‚¬${data.grenkeFee.toFixed(2)}`;
            
            document.getElementById('capexAmt').textContent = `-â‚¬${data.capexTotal.toFixed(2)}`;
            
            const totalMono = data.baseMono + data.addMono;
            const totalCol = data.baseCol + data.addCol;
            document.getElementById('ricohLogic').textContent = `(${totalMono.toLocaleString()}m Ã— â‚¬${RICOH_CPP.mono}) + (${totalCol.toLocaleString()}c Ã— â‚¬${RICOH_CPP.colour})`;
            document.getElementById('ricohAmt').textContent = `-â‚¬${data.serviceCost.toFixed(2)}`;

            document.getElementById('profitAmt').textContent = `â‚¬${data.netProfit.toFixed(2)}`;
            const marginEl = document.getElementById('marginAmt');
            marginEl.textContent = `${data.margin.toFixed(1)}%`;
            marginEl.style.color = data.margin >= 50 ? 'green' : 'orange';

            document.getElementById('monthlyDisplay').textContent = `â‚¬${data.totalMonthly.toFixed(2)}`;
            document.getElementById('monthlyVatDisplay').textContent = `â‚¬${(data.totalMonthly*1.23).toFixed(2)}`;
            
            document.getElementById('result').classList.remove('hidden');

            // Capture Preview State
            const finalDeviceList = [];
            document.querySelectorAll('[id^="mps-chk-"]').forEach(chk => {
                const parts = chk.id.split('-');
                const unitNum = parts.pop();
                const locInput = document.getElementById(chk.id.replace('mps-chk-', 'mps-loc-'));
                finalDeviceList.push({
                    model: chk.dataset.model,
                    unitNum: unitNum,
                    isManaged: chk.checked,
                    location: locInput ? locInput.value.trim() : `Unit #${unitNum}`
                });
            });

            quoteState = {
                clientName: document.getElementById('clientName').value || "Draft Quote",
                clientEmail: document.getElementById('clientEmail').value || "",
                clientSector: document.getElementById('clientSector').value || "",
                date: new Date().toLocaleDateString('en-IE'),
                finalDeviceList, 
                baseMono: data.baseMono, baseCol: data.baseCol,
                addMono: data.addMono, addCol: data.addCol,
                monthlyExVat: data.totalMonthly.toFixed(2),
                monthlyIncVat: (data.totalMonthly*1.23).toFixed(2)
            };
        }

        function goToPreview() {
            if (!quoteState) calculateQuote();
            sessionStorage.setItem('quoteData', JSON.stringify(quoteState));
            window.location.href = 'liosdoire_preview_v15_6.html';
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
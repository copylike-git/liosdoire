<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liosdoire Quote v17.0 ‚Äî Unified App</title>
    
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* APP-SPECIFIC UTILITIES */
        .hidden { display: none !important; }
        
        /* PREVIEW PAGE SPECIFIC STYLES (Scoped) */
        #preview-view .page { 
            background: white; 
            width: 210mm; 
            min-height: 297mm; 
            margin: 0 auto; 
            padding: 15mm; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
            font-family: sans-serif; 
        }
        #preview-view .header-row { display: flex; justify-content: space-between; border-bottom: 2px solid #1e3a8a; padding-bottom: 15px; margin-bottom: 20px; }
        #preview-view h1 { margin: 0; color: #1e3a8a; font-size: 1.6rem; }
        #preview-view .sub-header { text-align: right; color: #64748b; font-size: 0.8rem; }
        
        #preview-view .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: #f8fafc; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0; margin-bottom: 20px; font-size: 0.9rem; }
        #preview-view .info-item strong { display: block; font-size: 0.7rem; color: #64748b; text-transform: uppercase; }
        
        #preview-view table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        #preview-view th { text-align: left; background: #f1f5f9; padding: 8px; border-bottom: 2px solid #e2e8f0; }
        #preview-view td { padding: 8px; border-bottom: 1px solid #e2e8f0; }
        
        #preview-view .financial-summary { display: flex; justify-content: flex-end; margin-top: 20px; }
        #preview-view .financial-table { width: 300px; text-align: right; }
        #preview-view .financial-table td { padding: 5px; }
        #preview-view .total-row { font-weight: bold; color: #1e3a8a; font-size: 1.1rem; border-top: 2px solid #1e3a8a; }
        
        #preview-view .credit-box { background: #f0f9ff; padding: 15px; border-radius: 6px; border: 1px solid #bae6fd; margin-top: 20px; }
        #preview-view .credit-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; text-align: center; }
        #preview-view .credit-val { font-size: 1.2rem; font-weight: bold; color: #0284c7; display: block; }
        #preview-view .credit-lbl { font-size: 0.75rem; color: #64748b; text-transform: uppercase; }
        
        #preview-view .sig-section { margin-top: 30px; }
        #preview-view .sig-box { height: 120px; border: 2px dashed #cbd5e1; background: #fcfcfc; border-radius: 6px; position: relative; }
        
        /* Buttons specific to preview */
        .preview-actions { text-align: center; margin-top: 40px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin-bottom: 50px; }
        .btn-xero { background: #13b5ea; }
        .btn-xero:hover { background: #0e9ccb; }

        /* LOADING OVERLAY */
        #loadingOverlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); color: white; z-index: 999; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #1e3a8a; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media print {
            body { background: white; padding: 0; }
            #view-calculator, .preview-actions, .no-print { display: none !important; }
            #view-preview { display: block !important; }
            #preview-view .page { box-shadow: none; margin: 0; padding: 15mm; }
        }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div id="loadingText">Submitting...</div>
    </div>

    <form id="fs-form" action="https://formspree.io/f/xdannjrl" method="POST" style="display:none;">
        <input type="hidden" name="_subject" id="fs-subject" value="New Order">
        <input type="text" name="-- APPROVAL METRICS --" value="" readonly>
        <input type="text" name="Total Monthly Revenue" id="fs-total">
        <input type="text" name="Net Cash Profit" id="fs-profit">
        <input type="text" name="Net Margin %" id="fs-margin">
        <input type="text" name="Hardware CapEx" id="fs-capex">
        <input type="text" name="Ricoh Service Cost" id="fs-service">
        <input type="text" name="Grenke Fee" id="fs-grenke">
        <input type="text" name="Cash In Bank" id="fs-cash">
        <input type="text" name="-- CLIENT --" value="" readonly>
        <input type="text" name="Client Name" id="fs-client">
        <input type="text" name="Email" id="fs-email">
        <input type="text" name="Date" id="fs-date">
        <input type="text" name="-- ITEMS --" value="" readonly>
        <div id="fs-device-list"></div>
        <input type="hidden" name="Signature_Image" id="fs-sig-link">
    </form>

    <div id="view-calculator">
        <header>
            <div class="subtitle">
                <img src="https://liosdoirecomputers.com/wp-content/uploads/2023/01/LiosdoireComputerslogo-o8.png" width="120" alt="Liosdoire Logo">
            </div>
            <br><strong>Liosdoire Computers - Quote v17.0</strong>
        </header>

        <div id="app">
            <div class="section">
                <div class="section-title">1. Client Information</div>
                <div class="client-info-grid">
                    <div><label>Client Name</label><input type="text" id="clientName" placeholder="e.g. St. Brendan's School"></div>
                    <div><label>Email</label><input type="email" id="clientEmail" placeholder="admin@school.ie"></div>
                    <div><label>Phone</label><input type="tel" id="clientPhone" placeholder="08x xxx xxxx"></div>
                    <div><label>Sector</label><select id="clientSector"><option value="">Select...</option><option value="Education">Education</option><option value="Business">Business</option></select></div>
                    <div style="grid-column: span 2;">
                        <label style="color:var(--primary);"><strong>Grenke Finance Rate (Internal):</strong></label>
                        <select id="grenkeRate" style="border: 2px solid #cbd5e1; background-color: #f8fafc;">
                            <option value="0">0% (Direct/Cash)</option>
                            <option value="1.5">1.5% (Promo)</option>
                            <option value="3.0">3.0% (Standard)</option>
                            <option value="4.5" selected>4.5% (Safe/High Risk)</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">2. Select Devices</div>
                <div class="device-grid" id="deviceList"></div>
            </div>

            <div class="section">
                <div class="section-title">3. Managed Print (Per Unit)</div>
                <div style="margin: 16px 0;">
                    <label>Select Pack Level (‚Ç¨20 Basic):</label>
                    <select id="packSelect" style="margin-top: 4px;">
                        <option value="Basic">RSI Basic ‚Äî ‚Ç¨20/mo</option>
                        <option value="Plus">RSI Plus ‚Äî ‚Ç¨35/mo</option>
                        <option value="Platinum">RSI Platinum ‚Äî ‚Ç¨45/mo</option>
                    </select>
                </div>
                <div id="mpsDeviceContainer" class="mps-list">
                    <div style="padding:15px; color:#64748b; text-align:center;">No devices selected.</div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">4. Print Credit Dashboard</div>
                <div class="dashboard-container">
                    <div class="control-group" style="background:#f8fafc; border-color:#94a3b8;">
                        <span class="tag tag-blue">Hardware Mix</span>
                        <div class="col-header">Mono Mix %</div>
                        <div class="slider-wrapper"><input type="range" id="sliderBaseMono" class="slider-black" orient="vertical" min="0" max="100" value="75" step="1"></div>
                        <div class="display-val" id="dispPctMono">75%</div>
                        <input type="text" id="readBaseMono" class="manual-input" readonly style="background:#e2e8f0; color:#64748b;" value="0">
                    </div>
                    <div class="control-group" style="background:#f8fafc; border-color:#94a3b8;">
                        <span class="tag tag-blue">Hardware Mix</span>
                        <div class="col-header">Colour Mix %</div>
                        <div class="slider-wrapper"><input type="range" id="sliderBaseColour" class="slider-rainbow" orient="vertical" min="0" max="100" value="25" step="1"></div>
                        <div class="display-val" id="dispPctCol">25%</div>
                        <input type="text" id="readBaseColour" class="manual-input" readonly style="background:#e2e8f0; color:#64748b;" value="0">
                    </div>
                    <div class="control-group">
                        <span class="tag tag-green">Add-on</span>
                        <div class="col-header">Extra Mono</div>
                        <div class="slider-wrapper"><input type="range" id="sliderAddonMono" class="slider-black" orient="vertical" min="0" max="1000000" step="1000" value="0"></div>
                        <input type="number" id="inputAddonMono" class="manual-input" value="0" step="1000">
                    </div>
                    <div class="control-group">
                        <span class="tag tag-green">Add-on</span>
                        <div class="col-header">Extra Colour</div>
                        <div class="slider-wrapper"><input type="range" id="sliderAddonColour" class="slider-rainbow" orient="vertical" min="0" max="1000000" step="1000" value="0"></div>
                        <input type="number" id="inputAddonColour" class="manual-input" value="0" step="1000">
                    </div>
                </div>
                <div style="text-align:center; padding: 10px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px;">
                    <span style="color:#166534; font-weight:bold;">Total Retail Add-on Cost: <span id="addonCostDisplay" style="font-size:1.2rem">+‚Ç¨0.00</span> / mo</span>
                </div>
                <div class="live-total-box">
                    <span class="live-label">Estimated Monthly Total (Ex VAT)</span>
                    <span id="liveMonthlyDisplay" class="live-amount">‚Ç¨0.00</span>
                </div>
            </div>

            <div class="section">
                <div class="section-title">5. Finalize Quote</div>
                
                <div class="action-bar">
                    <button id="calculateBtn" class="success" style="flex:1;">Calculate / Preview Quote</button>
                    <label class="action-checkbox"><input type="checkbox" id="showBreakdownChk"> Review Internal Margin & Costs</label>
                </div>
                
                <div id="result" class="result">
                    <h3 style="color:var(--primary); border-bottom:1px solid #cbd5e1; padding-bottom:5px;">Internal Financial Breakdown</h3>
                    <table class="result-table">
                        <thead><tr><th>Item</th><th>Logic</th><th>Amount (‚Ç¨)</th></tr></thead>
                        <tbody>
                            <tr><td>(+) Hardware Lease</td><td><span class="calc-detail">Device Monthly Total</span></td><td id="deviceAmt"></td></tr>
                            <tr><td>(+) MPS Pack</td><td><span class="calc-detail">Pack Cost √ó Active Units</span></td><td id="mpsAmt"></td></tr>
                            <tr style="background:#f0fdf4"><td><strong>(+) Retail Add-on</strong></td><td><span class="calc-detail">Extra Pages Revenue / 60</span></td><td id="retailAddonAmt" style="font-weight:bold; color:#166534"></td></tr>
                            <tr style="background:#e0f2fe; border-top: 2px solid #cbd5e1; border-bottom: 2px solid #cbd5e1;"><td><strong>(=) Monthly Revenue</strong></td><td><span class="calc-detail">Sum of above</span></td><td id="totalMonthlyAmt" style="font-weight:bold; color:var(--primary);"></td></tr>
                            <tr style="background:#f8fafc"><td><strong>Total Contract Revenue (60 Mo)</strong></td><td><span class="calc-detail">Monthly √ó 60</span></td><td id="grossContractAmt" style="font-weight:bold;"></td></tr>
                            <tr><td>(-) Grenke Finance Fee</td><td><span id="grenkeLogic" class="calc-detail"></span></td><td id="grenkeAmt" style="color:red"></td></tr>
                            <tr><td>(-) Hardware CapEx</td><td><span id="capexLogic" class="calc-detail"></span></td><td id="capexAmt" style="color:red"></td></tr>
                            <tr><td>(-) Service Cost (Ricoh)</td><td><span id="ricohLogic" class="calc-detail"></span></td><td id="ricohAmt" style="color:red"></td></tr>
                            <tr style="background:#e0f2fe; border-top: 2px solid #cbd5e1;"><td><strong>(=) Net Cash Profit</strong></td><td><span class="calc-detail">Cash In Bank - Costs</span></td><td id="profitAmt" style="font-weight:bold; font-size:1.1rem; color:var(--success);"></td></tr>
                            <tr><td><strong>Net Margin %</strong></td><td><span class="calc-detail">Profit / Cash In Bank</span></td><td id="marginAmt" style="font-weight:bold"></td></tr>
                        </tbody>
                    </table>
                    <button id="goToPreviewBtn" class="secondary" style="margin-top: 15px; width: 100%;">üìÑ Proceed to Order / Preview</button>
                </div>
            </div>
        </div>
    </div>

    <div id="view-preview" class="hidden">
        <div id="preview-view">
            <div class="page" id="quote-content">
                <div class="header-row">
                    <h1>Quotation & Order Form</h1>
                    <div class="sub-header"><strong>Liosdoire Computers</strong><br>Managed Print Services<br>Date: <span id="pDate"></span></div>
                </div>

                <div class="info-grid">
                    <div class="info-item"><strong>Client Name</strong><span id="pClient"></span></div>
                    <div class="info-item"><strong>Sector</strong><span id="pSector"></span></div>
                    <div class="info-item"><strong>Email</strong><span id="pEmail"></span></div>
                    <div class="info-item"><strong>Contract Term</strong><span>60 Months</span></div>
                </div>

                <h3 style="color:#1e3a8a; border-bottom:1px solid #e2e8f0; padding-bottom:5px;">Hardware & Services Schedule</h3>
                <table>
                    <thead><tr><th>ID</th><th>Description</th><th>Service & Location</th></tr></thead>
                    <tbody id="pDeviceTable"></tbody>
                </table>

                <div class="financial-summary">
                    <table class="financial-table">
                        <tr><td>Monthly Hardware & Service:</td><td>‚Ç¨<span id="pExVat">0.00</span></td></tr>
                        <tr><td>VAT (23%):</td><td>‚Ç¨<span id="pVat">0.00</span></td></tr>
                        <tr class="total-row"><td>Total Monthly Charge:</td><td>‚Ç¨<span id="pIncVat">0.00</span></td></tr>
                    </table>
                </div>

                <div class="credit-box">
                    <div style="font-weight:bold; color:#0369a1; margin-bottom:10px; font-size:0.9rem;">INCLUDED PRINT ALLOWANCE (Total Pool for 60 Months)</div>
                    <div class="credit-grid">
                        <div class="credit-item"><span class="credit-val" id="pTotalMono">0</span><span class="credit-lbl">Mono Pages</span></div>
                        <div class="credit-item"><span class="credit-val" id="pTotalCol">0</span><span class="credit-lbl">Colour Pages</span></div>
                        <div class="credit-item">
                            <div style="font-size:0.8rem; color:#64748b;">Add-on:</div>
                            <div style="font-size:0.9rem; font-weight:600;" id="pAddonSummary">None</div>
                        </div>
                    </div>
                </div>

                <div style="font-size:0.7rem; color:#94a3b8; margin-top:30px; text-align:justify; line-height:1.4; border-top:1px solid #e2e8f0; padding-top:10px;">
                    <strong>Terms & Conditions:</strong><br>
                    1. All print credits and Cost Per Page (CPP) rates are calculated based on ISO 19752.<br>
                    2. This agreement is a 60-month lease via Grenke Finance.<br>
                    3. Devices marked "Managed Service" include toner, service, and parts.<br>
                    4. This quotation is valid for 30 days.
                </div>

                <div class="sig-section">
                    <h3 style="margin-bottom:10px; color:#1e3a8a;">Authorisation</h3>
                    <p style="font-size:0.8rem; color:#64748b;">By signing below, I confirm I am authorised to order on behalf of the client.</p>
                    <div class="sig-box"><canvas id="sigCanvas" style="width: 100%; height: 100%;"></canvas></div>
                    <div style="display:flex; justify-content:space-between; margin-top:5px;">
                        <span style="font-size:0.8rem; color:#64748b;">Client Signature</span>
                        <button onclick="clearSig()" class="no-print" style="font-size:0.75rem; padding:4px 8px; cursor:pointer;">Clear</button>
                    </div>
                </div>
            </div>

            <div class="preview-actions">
                <button onclick="exportXeroCSV()" class="btn btn-xero">‚¨áÔ∏è Download Xero CSV</button>
                <button onclick="submitOrder()" class="btn btn-submit" style="background:#1e3a8a; color:white;">üöÄ Submit Order to Office</button>
            </div>
            
            <div style="text-align:center; padding-bottom:50px;">
                <a href="#" onclick="showCalculator(); return false;" style="color:#cbd5e1; text-decoration:none;">‚Üê Edit Quote (Go Back)</a>
            </div>
        </div>
    </div>

    <script>
        const RICOH_CPP = { mono: 0.0038, colour: 0.038 }; 
        const RETAIL_CPP = { mono: 0.005, colour: 0.05 };  
        const MARGIN_TARGET = 0.50;
        const DEVICES = [
            { model: "Ricoh IM 7000", desc: "Ricoh IM 7000 (A3 Mono)", cost: 300.00, capex: 4150 },
            { model: "Ricoh IM C3010", desc: "Ricoh IM C3010 (A3 Colour)", cost: 150.00, capex: 2000 },
            { model: "Ricoh IM C320F", desc: "Ricoh IM C320F (A4 Colour)", cost: 50.00, capex: 1000 },
            { model: "Ricoh IM 370", desc: "Ricoh IM 370 (A4 Mono)", cost: 25.00, capex: 700 },
            { model: "Ricoh IM 3000", desc: "Ricoh IM 3000 (A3 Mono)", cost: 100.00, capex: 1710 }
        ];
        const PACKS = { Basic: 20.00, Plus: 35.00, Platinum: 45.00 };
        
        let quoteState = null;
        let canvas, ctx, isDrawing = false;

        document.addEventListener('DOMContentLoaded', init);

        function init() {
            // Initialize Calculator
            const list = document.getElementById('deviceList');
            list.innerHTML = DEVICES.map(d => {
                const safeModel = d.model.replace(/\s+/g, '_');
                return `<div class="device-item">
                    <div class="device-info"><div class="device-name">${d.desc}</div><div class="device-financials">‚Ç¨${d.cost}/mo</div></div>
                    <div class="qty-controls"><button onclick="adjustQty('${safeModel}', -1)">-</button><input type="number" id="qty-${safeModel}" value="0" readonly style="width:50px; text-align:center; background:#f1f5f9;"><button onclick="adjustQty('${safeModel}', 1)">+</button></div>
                </div>`;
            }).join('');

            const sBaseMono = document.getElementById('sliderBaseMono'), sBaseCol = document.getElementById('sliderBaseColour');
            sBaseMono.addEventListener('input', (e) => { sBaseCol.value = 100 - parseInt(e.target.value); updateMix(); });
            sBaseCol.addEventListener('input', (e) => { sBaseMono.value = 100 - parseInt(e.target.value); updateMix(); });

            const ids = [['sliderAddonMono', 'inputAddonMono'], ['sliderAddonColour', 'inputAddonColour']];
            ids.forEach(([sId, iId]) => {
                const s = document.getElementById(sId), i = document.getElementById(iId);
                const sync = () => { updateAddonCost(); calculateAll(); }; 
                s.addEventListener('input', (e) => { i.value = e.target.value; sync(); });
                i.addEventListener('input', (e) => { s.value = e.target.value; sync(); });
            });

            document.getElementById('grenkeRate').addEventListener('change', calculateAll);
            document.getElementById('packSelect').addEventListener('change', calculateAll);
            
            // Buttons
            document.getElementById('calculateBtn').addEventListener('click', handleCalculateClick);
            document.getElementById('goToPreviewBtn').addEventListener('click', showPreview);
        }

        // --- NAVIGATION LOGIC ---
        function showPreview() {
            if (!quoteState) calculateAll();
            if (parseFloat(quoteState.monthlyExVat) === 0) { alert("Please select at least one device."); return; }
            
            document.getElementById('view-calculator').classList.add('hidden');
            document.getElementById('view-preview').classList.remove('hidden');
            document.window.scrollTo(0,0);
            
            populatePreview();
            initCanvas(); // Initialize signature canvas when visible
        }

        function showCalculator() {
            document.getElementById('view-preview').classList.add('hidden');
            document.getElementById('view-calculator').classList.remove('hidden');
            document.window.scrollTo(0,0);
        }

        // --- CALCULATOR LOGIC ---
        function handleCalculateClick() {
            calculateAll(); 
            const showBreakdown = document.getElementById('showBreakdownChk').checked;
            
            if (showBreakdown) {
                document.getElementById('result').classList.add('visible');
                document.getElementById('result').scrollIntoView({behavior: "smooth"});
            } else {
                showPreview();
            }
        }

        function calculateAll() {
            const data = getFinancials();
            document.getElementById('liveMonthlyDisplay').textContent = `‚Ç¨${data.totalMonthly.toFixed(2)}`;
            if (data.totalMonthly === 0) return;

            document.getElementById('deviceAmt').textContent = `‚Ç¨${data.deviceMonthly.toFixed(2)}`;
            document.getElementById('mpsAmt').textContent = `‚Ç¨${data.mpsMonthly.toFixed(2)}`;
            document.getElementById('retailAddonAmt').textContent = `‚Ç¨${data.addonMonthly.toFixed(2)}`;
            document.getElementById('totalMonthlyAmt').textContent = `‚Ç¨${data.totalMonthly.toFixed(2)}`;
            document.getElementById('grossContractAmt').textContent = `‚Ç¨${data.grossContractVal.toFixed(2)}`;
            document.getElementById('grenkeLogic').textContent = `‚Ç¨${data.grossContractVal.toFixed(0)} √ó ${data.grenkeRatePct}%`;
            document.getElementById('grenkeAmt').textContent = `-‚Ç¨${data.grenkeFee.toFixed(2)}`;
            document.getElementById('capexAmt').textContent = `-‚Ç¨${data.capexTotal.toFixed(2)}`;
            document.getElementById('ricohLogic').textContent = `(${data.baseMono}m + ${data.addMono}m) + col...`;
            document.getElementById('ricohAmt').textContent = `-‚Ç¨${data.serviceCost.toFixed(2)}`;
            document.getElementById('profitAmt').textContent = `‚Ç¨${data.netProfit.toFixed(2)}`;
            document.getElementById('marginAmt').textContent = `${data.margin.toFixed(1)}%`;
            
            saveState(data);
        }

        function getFinancials() {
            const grenkeRatePct = parseFloat(document.getElementById('grenkeRate').value);
            const grenkeRate = grenkeRatePct / 100;
            let deviceMonthly = 0, capexTotal = 0;
            DEVICES.forEach(d => {
                const qty = getQty(d.model);
                if(qty > 0) { deviceMonthly += qty * d.cost; capexTotal += qty * d.capex; }
            });
            let mpsMonthly = 0;
            const packCost = PACKS[document.getElementById('packSelect').value];
            document.querySelectorAll('[id^="mps-chk-"]').forEach(chk => { if(chk.checked) mpsMonthly += packCost; });
            const addMono = parseInt(document.getElementById('inputAddonMono').value) || 0;
            const addCol = parseInt(document.getElementById('inputAddonColour').value) || 0;
            const addonRevenueTotal = (addMono * RETAIL_CPP.mono) + (addCol * RETAIL_CPP.colour);
            const addonMonthly = addonRevenueTotal / 60;
            const totalMonthly = deviceMonthly + mpsMonthly + addonMonthly;
            const grossContractVal = totalMonthly * 60;
            const grenkeFee = grossContractVal * grenkeRate;
            const cashInBank = grossContractVal - grenkeFee;
            const baseMono = parseInt(document.getElementById('readBaseMono').value.replace(/,/g, '')) || 0;
            const baseCol = parseInt(document.getElementById('readBaseColour').value.replace(/,/g, '')) || 0;
            const serviceCost = ((baseMono + addMono) * RICOH_CPP.mono) + ((baseCol + addCol) * RICOH_CPP.colour);
            const netProfit = cashInBank - capexTotal - serviceCost;
            const margin = (netProfit / (cashInBank || 1)) * 100;
            return { deviceMonthly, mpsMonthly, addonMonthly, totalMonthly, grenkeFee, netProfit, margin, capexTotal, serviceCost, grossContractVal, cashInBank, baseMono, baseCol, addMono, addCol, grenkeRatePct };
        }

        function saveState(data) {
            const finalDeviceList = [];
            document.querySelectorAll('[id^="mps-chk-"]').forEach(chk => {
                const parts = chk.id.split('-');
                const unitNum = parts.pop();
                const locInput = document.getElementById(chk.id.replace('mps-chk-', 'mps-loc-'));
                finalDeviceList.push({
                    model: chk.dataset.model,
                    unitNum: unitNum,
                    isManaged: chk.checked,
                    location: locInput ? locInput.value.trim() : `Unit #${unitNum}`
                });
            });

            quoteState = {
                clientName: document.getElementById('clientName').value || "Draft Quote",
                clientEmail: document.getElementById('clientEmail').value || "",
                clientSector: document.getElementById('clientSector').value || "",
                date: new Date().toLocaleDateString('en-IE'),
                finalDeviceList, 
                baseMono: data.baseMono, baseCol: data.baseCol,
                addMono: data.addMono, addCol: data.addCol,
                monthlyExVat: data.totalMonthly.toFixed(2),
                monthlyIncVat: (data.totalMonthly*1.23).toFixed(2),
                financials: {
                    grossContract: data.grossContractVal.toFixed(2),
                    grenkeFee: data.grenkeFee.toFixed(2),
                    cashInBank: data.cashInBank.toFixed(2),
                    capex: data.capexTotal.toFixed(2),
                    serviceCost: data.serviceCost.toFixed(2),
                    netProfit: data.netProfit.toFixed(2),
                    margin: data.margin.toFixed(1) + "%"
                }
            };
        }

        // --- PREVIEW LOGIC ---
        function populatePreview() {
            if (!quoteState) return;
            
            document.getElementById('pClient').textContent = quoteState.clientName;
            document.getElementById('pEmail').textContent = quoteState.clientEmail;
            document.getElementById('pDate').textContent = quoteState.date;
            document.getElementById('pSector').textContent = quoteState.clientSector;
            document.getElementById('pExVat').textContent = quoteState.monthlyExVat;
            document.getElementById('pVat').textContent = (parseFloat(quoteState.monthlyExVat)*0.23).toFixed(2);
            document.getElementById('pIncVat').textContent = quoteState.monthlyIncVat;

            const bM=quoteState.baseMono, bC=quoteState.baseCol, aM=quoteState.addMono, aC=quoteState.addCol;
            document.getElementById('pTotalMono').textContent = (bM+aM).toLocaleString();
            document.getElementById('pTotalCol').textContent = (bC+aC).toLocaleString();
            document.getElementById('pAddonSummary').textContent = (aM>0||aC>0) ? `${aM.toLocaleString()}m / ${aC.toLocaleString()}c` : "None";

            const tbody = document.getElementById('pDeviceTable');
            const fsList = document.getElementById('fs-device-list');
            
            tbody.innerHTML = ''; // Clear previous
            fsList.innerHTML = ''; 

            quoteState.finalDeviceList.forEach((d, i) => {
                const badge = d.isManaged ? '<strong style="color:#16a34a">Managed</strong>' : '<span style="color:#64748b">Hardware</span>';
                const loc = d.location ? `<br><span style="font-size:0.8rem; font-style:italic;">üìç ${d.location}</span>` : '';
                tbody.innerHTML += `<tr><td>#${i+1}</td><td><strong>${d.model}</strong></td><td>${badge} ${loc}</td></tr>`;
                
                const input = document.createElement('input');
                input.type = 'text'; input.name = `Item ${i+1}`; input.value = `${d.model} [${d.isManaged?'MPS':'HW'}] - ${d.location}`;
                fsList.appendChild(input);
            });

            // Fill Formspree Hidden Inputs
            document.getElementById('fs-client').value = quoteState.clientName;
            document.getElementById('fs-email').value = quoteState.clientEmail;
            document.getElementById('fs-date').value = quoteState.date;
            document.getElementById('fs-subject').value = "New Order: " + quoteState.clientName;
            document.getElementById('fs-total').value = "‚Ç¨" + quoteState.monthlyExVat;
            
            if(quoteState.financials) {
                document.getElementById('fs-profit').value = "‚Ç¨" + quoteState.financials.netProfit;
                document.getElementById('fs-margin').value = quoteState.financials.margin;
                document.getElementById('fs-capex').value = "-‚Ç¨" + quoteState.financials.capex;
                document.getElementById('fs-service').value = "-‚Ç¨" + quoteState.financials.serviceCost;
                document.getElementById('fs-grenke').value = "-‚Ç¨" + quoteState.financials.grenkeFee;
                document.getElementById('fs-cash').value = "‚Ç¨" + quoteState.financials.cashInBank;
            }
        }

        // --- SIGNATURE CANVAS ---
        function initCanvas() {
            canvas = document.getElementById('sigCanvas');
            if(!canvas) return;
            
            // Adjust resolution
            const rect = canvas.getBoundingClientRect();
            if (rect.width > 0 && rect.height > 0) {
                canvas.width = rect.width * 2;
                canvas.height = rect.height * 2;
                ctx = canvas.getContext('2d');
                ctx.scale(2, 2);
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.strokeStyle = "#000";
                
                // Clear old listeners to avoid duplicates if re-opened
                const newCanvas = canvas.cloneNode(true);
                canvas.parentNode.replaceChild(newCanvas, canvas);
                canvas = newCanvas;
                ctx = canvas.getContext('2d');
                ctx.scale(2, 2);
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.strokeStyle = "#000";

                ['mousedown','touchstart'].forEach(ev=>canvas.addEventListener(ev, startDraw));
                ['mousemove','touchmove'].forEach(ev=>canvas.addEventListener(ev, draw));
                ['mouseup','touchend','mouseout'].forEach(ev=>canvas.addEventListener(ev, stopDraw));
            }
        }
        function startDraw(e) { isDrawing=true; ctx.beginPath(); const p=getPos(e); ctx.moveTo(p.x, p.y); if(e.type!=='mousedown')e.preventDefault(); }
        function draw(e) { if(!isDrawing)return; const p=getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); if(e.type!=='mousemove')e.preventDefault(); }
        function stopDraw() { isDrawing=false; }
        function clearSig() { ctx.clearRect(0,0,canvas.width,canvas.height); }
        function getPos(e) { const r=canvas.getBoundingClientRect(); const c=e.changedTouches?e.changedTouches[0]:e; return {x:c.clientX-r.left, y:c.clientY-r.top}; }

        // --- EXPORT FUNCTIONS ---
        function exportXeroCSV() {
            if (!quoteState) return;
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "*ContactName,EmailAddress,POAddressLine1,*InvoiceDate,*DueDate,*Description,*Quantity,*UnitAmount,*AccountCode,*TaxType\n";
            const contact = `"${quoteState.clientName}"`;
            const totalDesc = `"Managed Print Services Monthly Fee (60 Months) - ${quoteState.finalDeviceList.length} Units"`;
            const row = [contact, `"${quoteState.clientEmail}"`, "", `"${quoteState.date}"`, `"${quoteState.date}"`, totalDesc, "1", quoteState.monthlyExVat, "200", "23% VAT on Income"].join(",");
            csvContent += row + "\n";
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `Xero_${quoteState.clientName.replace(/ /g,"_")}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function submitOrder() {
            const sigCanvas = document.getElementById('sigCanvas');
            if(!sigCanvas) return alert("Signature Error");
            if(!confirm("Submit Order to Office?")) return;

            document.getElementById('loadingOverlay').style.display = 'flex';
            try {
                const dataUrl = sigCanvas.toDataURL("image/png");
                document.getElementById('fs-sig-link').value = dataUrl;
                const form = document.getElementById('fs-form');
                const formData = new FormData(form);
                const response = await fetch("https://formspree.io/f/xdannjrl", { method: "POST", body: formData, headers: { 'Accept': 'application/json' } });
                if (response.ok) alert("‚úÖ Order Sent Successfully!");
                else alert("‚ö†Ô∏è Email failed.");
            } catch (err) { alert("Error: " + err.message); } 
            finally { document.getElementById('loadingOverlay').style.display = 'none'; }
        }

        // Helpers
        function updateMix() { const sBaseMono = document.getElementById('sliderBaseMono'); const sBaseCol = document.getElementById('sliderBaseColour'); document.getElementById('dispPctMono').textContent = sBaseMono.value + '%'; document.getElementById('dispPctCol').textContent = sBaseCol.value + '%'; recalculateBaseCredit(); calculateAll(); }
        function adjustQty(modelSafe, delta) { const el = document.getElementById(`qty-${modelSafe}`); el.value = Math.max(0, (parseInt(el.value)||0)+delta); renderMpsList(); recalculateBaseCredit(); calculateAll(); }
        function getQty(model) { return parseInt(document.getElementById(`qty-${model.replace(/\s+/g, '_')}`).value) || 0; }
        function updateAddonCost() { const m = parseInt(document.getElementById('inputAddonMono').value)||0; const c = parseInt(document.getElementById('inputAddonColour').value)||0; const val = (m*RETAIL_CPP.mono)+(c*RETAIL_CPP.colour); document.getElementById('addonCostDisplay').textContent = `+‚Ç¨${(val/60).toFixed(2)}`; }
    </script>
</body>
</html>
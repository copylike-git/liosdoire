<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liosdoire Smart Quote v9.2</title>
    <style>
        :root { --primary: #1e3a8a; --success: #16a34a; --warning: #d97706; --danger: #dc2626; --light: #f8fafc; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { background: var(--light); color: #1e293b; padding: 16px; max-width: 900px; margin: 0 auto; }
        
        header { text-align: center; padding: 20px 0; border-bottom: 2px solid #e2e8f0; }
        .subtitle { color: #64748b; font-size: 0.9rem; }
        
        .section { background: white; border-radius: 12px; padding: 20px; margin: 16px 0; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .section-title { font-size: 1.25rem; font-weight: 600; color: var(--primary); margin-bottom: 4px; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; }
        .section-desc { font-size: 0.85rem; color: #64748b; margin-bottom: 16px; font-style: italic; }

        /* DEVICE LIST */
        .device-grid { display: grid; gap: 12px; }
        .device-item { 
            display: flex; align-items: center; padding: 12px; 
            border: 1px solid #e2e8f0; border-radius: 8px; transition: 0.2s; 
        }
        .device-item:hover { border-color: var(--primary); background: #f0f9ff; }
        .device-info { flex: 1; }
        .device-name { font-weight: 700; color: #1e293b; }
        .device-financials { font-size: 0.85rem; color: #64748b; margin-top: 4px; }
        .device-allowance { 
            font-size: 0.8rem; font-weight: 600; color: var(--success); 
            background: #dcfce7; padding: 2px 8px; border-radius: 4px; 
            display: inline-block; margin-top: 4px;
        }
        .device-allowance.low { color: var(--danger); background: #fee2e2; }

        /* CONTROLS */
        .qty-controls { display: flex; align-items: center; gap: 8px; }
        button { background: var(--primary); color: white; border: none; border-radius: 6px; padding: 10px 16px; font-weight: 600; cursor: pointer; }
        button:disabled { opacity: 0.5; cursor: not-allowed; background: #94a3b8; }
        button.secondary { background: #64748b; }
        button.success { background: var(--success); }
        input, select { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 1rem; width: 100%; }
        
        /* VALIDATION STYLES */
        input.error { border: 2px solid var(--danger); background: #fef2f2; }
        .validation-msg { color: var(--danger); font-size: 0.85rem; font-weight: 600; margin-top: 6px; display: none; }
        .validation-msg.visible { display: block; }

        /* RESULTS TABLE */
        .result { background: #f1f5f9; border-radius: 8px; padding: 20px; margin-top: 16px; }
        .result-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
        .result-table th, .result-table td { text-align: left; padding: 10px 12px; border-bottom: 1px solid #cbd5e1; }
        .result-table th { background: #e2e8f0; font-weight: 600; }
        .result-total { font-weight: 700; font-size: 1.1rem; color: var(--primary); border-top: 2px solid #cbd5e1; padding-top: 12px; }
        
        .client-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        label { display: block; margin: 4px 0; font-weight: 500; font-size: 0.9rem; }
        .source-note { font-size: 0.75rem; color: #94a3b8; margin-top: 8px; }
        .hidden { display: none; }
        
        /* TERMS BOX */
        .terms-box {
            margin-top: 20px;
            padding: 12px;
            background: #fff;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 0.75rem;
            color: #475569;
            line-height: 1.4;
        }
        .terms-box strong { color: #1e293b; display: block; margin-bottom: 4px; }

        @media (max-width: 600px) {
            .client-info-grid { grid-template-columns: 1fr; }
            .device-item { flex-direction: column; align-items: flex-start; }
            .qty-controls { width: 100%; justify-content: space-between; margin-top: 10px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="subtitle">
            <img src="https://liosdoirecomputers.com/wp-content/uploads/2023/01/LiosdoireComputerslogo-o8.png" width="120" alt="Liosdoire Logo">
        </div>
        <br><strong>Liosdoire Computers - Smart Quote v9.2</strong>
    </header>

    <div id="app">
        <div class="section">
            <div class="section-title">1. Client Information</div>
            <div class="client-info-grid">
                <div><label>Client Name *</label><input type="text" id="clientName" placeholder="e.g. St. Brendan's School" required></div>
                <div><label>Email *</label><input type="email" id="clientEmail" placeholder="admin@school.ie" required></div>
                <div><label>Phone</label><input type="tel" id="clientPhone" placeholder="08x xxx xxxx"></div>
                <div><label>Sector *</label><select id="clientSector" required>
                    <option value="">Select...</option><option value="Education">Education</option><option value="Business">Business</option>
                </select></div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">2. Select Devices</div>
            <div class="section-desc">Suggested Print Volumes are calculated to maintain 50% margin using 75% Mono / 25% Colour split.</div>
            <div class="device-grid" id="deviceList"></div>
        </div>

        <div class="section">
            <div class="section-title">3. Managed Print (Optional)</div>
            <div><label><input type="checkbox" id="mpsToggle"> Include Cloud Management / Support Pack?</label></div>
            <div id="mpsOptions" class="hidden">
                <div style="margin: 16px 0;">
                    <label>Select Pack:</label>
                    <select id="packSelect" style="margin-top: 4px;">
                        <option value="Basic">RSI Basic ‚Äî ‚Ç¨20/mo</option>
                        <option value="Plus">RSI Plus ‚Äî ‚Ç¨35/mo</option>
                        <option value="Platinum">RSI Platinum ‚Äî ‚Ç¨45/mo</option>
                    </select>
                </div>
                <div><label>Quantity:</label><input type="number" id="mpsMachines" min="1" value="1"></div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">4. Print Credit Allocation</div>
            <div style="margin-bottom: 16px;">
                <label><strong>Included Print Credit (60 Months):</strong></label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 8px;">
                    <div><label style="font-size:0.8rem">Mono Pages</label><input type="number" id="monoIncluded" value="0"></div>
                    <div><label style="font-size:0.8rem">Colour Pages</label><input type="number" id="colourIncluded" value="0"></div>
                </div>
                <div id="creditWarning" class="validation-msg">‚ö†Ô∏è Error: Exceeds 50% margin safety limit.</div>
                <div id="creditInfo" class="source-note" style="color: var(--success); font-weight: bold;">‚úÖ Within safety margin.</div>
            </div>
            <div class="excess-section" style="background: #f0f9ff; padding: 15px; border-radius: 6px;">
                <label><strong>Excess Rates (Pay-per-print):</strong></label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 8px;">
                    <div><input type="number" id="monoExcess" placeholder="Est. Excess Mono/Year"></div>
                    <div><input type="number" id="colourExcess" placeholder="Est. Excess Colour/Year"></div>
                </div>
                <div class="source-note">Rates: ‚Ç¨0.005 Mono / ‚Ç¨0.05 Colour</div>
            </div>
        </div>

        <div style="margin-bottom: 16px; padding: 0 20px;">
            <label>Grenke Finance Rate:</label>
            <select id="grenkeRate">
                <option value="3.5">3.5% (Best Case)</option>
                <option value="4.0">4.0% (Standard)</option>
                <option value="5.0" selected>5.0% (Safe)</option>
            </select>
        </div>

        <div class="section">
            <div class="section-title">5. Quote Summary</div>
            <button id="calculateBtn" class="success">Calculate Full Quote</button>
            
            <div id="result" class="result hidden">
                <table class="result-table">
                    <thead><tr><th>Item</th><th>Amount (‚Ç¨)</th></tr></thead>
                    <tbody>
                        <tr style="background:#e0f2fe"><td><strong>Gross Contract Value</strong></td><td id="revenueAmt"></td></tr>
                        <tr><td>Net Profit (Cash)</td><td id="profitAmt" style="font-weight:bold"></td></tr>
                        <tr><td>Net Margin</td><td id="marginAmt" style="font-weight:bold"></td></tr>
                    </tbody>
                </table>
                <div style="margin-top:20px; text-align:right;">
                    <div style="font-size:1.2rem; color:var(--primary);"><strong>Monthly (Ex VAT): <span id="monthlyDisplay">‚Ç¨0.00</span></strong></div>
                    <div style="font-size:1rem; color:#64748b;">Inc VAT (23%): <span id="monthlyVatDisplay">‚Ç¨0.00</span></div>
                </div>
                
                <div class="terms-box">
                    <strong>Terms & Conditions of Service (CPP):</strong>
                    1. <strong>Standard Coverage:</strong> Calculations based on standard A4 paper with <strong>5% toner coverage</strong>.<br>
                    2. <strong>Validity:</strong> 60-month lease term via Grenke Finance.
                </div>

                <button id="previewBtn" class="secondary" style="margin-top: 15px; width: 100%;">üìÑ Proceed to Order / Preview</button>
            </div>
        </div>
    </div>

    <script>
        const MARGIN_TARGET = 0.50; 
        const RICOH_CPP = { mono: 0.0038, colour: 0.038 };
        
        // 75/25 Mixed Logic for Colour Machines
        const MIX_MONO = 0.75;
        const MIX_COLOUR = 0.25;

        const DEVICES = [
            { model: "Ricoh IM 7000", desc: "Ricoh IM 7000 (A3 Mono)", cost: 300.00, capex: 4150 },
            { model: "Ricoh IM C3010", desc: "Ricoh IM C3010 (A3 Colour)", cost: 150.00, capex: 2000 },
            { model: "Ricoh IM C320F", desc: "Ricoh IM C320F (A4 Colour)", cost: 50.00, capex: 1000 },
            { model: "Ricoh IM 370", desc: "Ricoh IM 370 (A4 Mono)", cost: 25.00, capex: 700 },
            { model: "Ricoh IM 3000", desc: "Ricoh IM 3000 (A3 Mono)", cost: 100.00, capex: 1710 }
        ];
        const PACKS = { Basic: 20.00, Plus: 35.00, Platinum: 45.00 };

        function getDeviceServiceBudget(device) {
            const revenue = device.cost * 60; 
            const requiredMargin = revenue * MARGIN_TARGET;
            return Math.max(0, revenue - device.capex - requiredMargin);
        }

        function getSuggestionText(device) {
            const budget = getDeviceServiceBudget(device);
            if (budget <= 0) return { text: "‚ö†Ô∏è Low Margin", class: "low" };
            
            if (device.desc.includes("Colour")) {
                const compositeCost = (MIX_MONO * RICOH_CPP.mono) + (MIX_COLOUR * RICOH_CPP.colour);
                const pages = Math.floor(budget / compositeCost);
                return { text: `Safe Vol: ~${pages.toLocaleString()} (Mixed 75/25)`, class: "" };
            } else {
                const pages = Math.floor(budget / RICOH_CPP.mono);
                return { text: `Safe Vol: ~${pages.toLocaleString()} (Mono)`, class: "" };
            }
        }

        function init() {
            const list = document.getElementById('deviceList');
            list.innerHTML = DEVICES.map(d => {
                const safeModel = d.model.replace(/\s+/g, '_');
                const suggestion = getSuggestionText(d);
                return `
                <div class="device-item">
                    <div class="device-info">
                        <div class="device-name">${d.desc}</div>
                        <div class="device-financials">‚Ç¨${d.cost}/mo</div>
                        <div class="device-allowance ${suggestion.class}">${suggestion.text}</div>
                    </div>
                    <div class="qty-controls">
                        <button onclick="adjustQty('${safeModel}', -1)">-</button>
                        <input type="number" id="qty-${safeModel}" value="0" readonly style="width:50px; text-align:center; background:#f1f5f9;">
                        <button onclick="adjustQty('${safeModel}', 1)">+</button>
                    </div>
                </div>`;
            }).join('');

            document.getElementById('mpsToggle').addEventListener('change', e => document.getElementById('mpsOptions').classList.toggle('hidden', !e.target.checked));
            document.getElementById('monoIncluded').addEventListener('input', validateSafetyMargin);
            document.getElementById('colourIncluded').addEventListener('input', validateSafetyMargin);
            document.getElementById('calculateBtn').addEventListener('click', calculateQuote);
            document.getElementById('previewBtn').addEventListener('click', goToPreview);
        }

        function adjustQty(modelSafe, delta) {
            const el = document.getElementById(`qty-${modelSafe}`);
            el.value = Math.max(0, (parseInt(el.value) || 0) + delta);
            recalculateDefaults();
        }

        function getQty(model) {
            return parseInt(document.getElementById(`qty-${model.replace(/\s+/g, '_')}`).value) || 0;
        }

        function recalculateDefaults() {
            let totalMonoPages = 0;
            let totalColourPages = 0;

            DEVICES.forEach(d => {
                const qty = getQty(d.model);
                if (qty > 0) {
                    const budget = getDeviceServiceBudget(d);
                    if (d.desc.includes("Colour")) {
                        const compositeCost = (MIX_MONO * RICOH_CPP.mono) + (MIX_COLOUR * RICOH_CPP.colour);
                        const totalSafePages = budget / compositeCost;
                        totalMonoPages += (totalSafePages * MIX_MONO) * qty;
                        totalColourPages += (totalSafePages * MIX_COLOUR) * qty;
                    } else {
                        totalMonoPages += (budget / RICOH_CPP.mono) * qty;
                    }
                }
            });
            document.getElementById('monoIncluded').value = Math.floor(totalMonoPages);
            document.getElementById('colourIncluded').value = Math.floor(totalColourPages);
            validateSafetyMargin();
        }

        function validateSafetyMargin() {
            let maxServiceBudget = 0;
            DEVICES.forEach(d => maxServiceBudget += getDeviceServiceBudget(d) * getQty(d.model));
            
            const currentServiceCost = ((parseInt(document.getElementById('monoIncluded').value)||0) * RICOH_CPP.mono) + 
                                     ((parseInt(document.getElementById('colourIncluded').value)||0) * RICOH_CPP.colour);

            const isFail = currentServiceCost > maxServiceBudget + 1;
            document.getElementById('creditWarning').classList.toggle('visible', isFail);
            document.getElementById('creditInfo').classList.toggle('hidden', isFail);
            document.getElementById('calculateBtn').disabled = isFail;
            document.getElementById('calculateBtn').textContent = isFail ? "‚ö†Ô∏è Margin Safety Violation" : "Calculate Full Quote";
        }

        let quoteState = null;

        function calculateQuote() {
            const clientName = document.getElementById('clientName').value;
            if(!clientName) { alert("Please enter Client Name"); return; }
            
            const grenkeRate = parseFloat(document.getElementById('grenkeRate').value) / 100;
            let deviceMonthly = 0, capexTotal = 0, quantities = {};
            
            DEVICES.forEach(d => {
                const qty = getQty(d.model);
                if(qty > 0) {
                    quantities[d.model] = qty;
                    deviceMonthly += qty * d.cost;
                    capexTotal += qty * d.capex;
                }
            });

            if (deviceMonthly === 0) { alert("Select at least one device"); return; }

            let mpsMonthly = 0;
            if(document.getElementById('mpsToggle').checked) {
                mpsMonthly = (parseInt(document.getElementById('mpsMachines').value) || 0) * PACKS[document.getElementById('packSelect').value];
            }

            const totalMonthly = deviceMonthly + mpsMonthly;
            const grossContractVal = totalMonthly * 60;
            const grenkeFee = grossContractVal * grenkeRate;
            const cashInBank = grossContractVal - grenkeFee;
            const serviceCost = ((parseInt(document.getElementById('monoIncluded').value)||0) * RICOH_CPP.mono) + 
                              ((parseInt(document.getElementById('colourIncluded').value)||0) * RICOH_CPP.colour);
            const netProfit = cashInBank - capexTotal - serviceCost;
            const margin = (netProfit / cashInBank) * 100;

            // Render
            document.getElementById('revenueAmt').textContent = `‚Ç¨${grossContractVal.toFixed(2)}`;
            document.getElementById('profitAmt').textContent = `‚Ç¨${netProfit.toFixed(2)}`;
            const marginEl = document.getElementById('marginAmt');
            marginEl.textContent = `${margin.toFixed(1)}%`;
            marginEl.style.color = margin >= 50 ? 'green' : 'red';
            document.getElementById('monthlyDisplay').textContent = `‚Ç¨${totalMonthly.toFixed(2)}`;
            document.getElementById('monthlyVatDisplay').textContent = `‚Ç¨${(totalMonthly*1.23).toFixed(2)}`;
            document.getElementById('result').classList.remove('hidden');

            // Store State
            quoteState = {
                clientName,
                clientEmail: document.getElementById('clientEmail').value,
                clientSector: document.getElementById('clientSector').value,
                date: new Date().toLocaleDateString('en-IE'),
                quantities,
                monoCredit: document.getElementById('monoIncluded').value,
                colourCredit: document.getElementById('colourIncluded').value,
                monthlyExVat: totalMonthly.toFixed(2),
                monthlyIncVat: (totalMonthly*1.23).toFixed(2)
            };
        }

        function goToPreview() {
            if (!quoteState) { calculateQuote(); }
            sessionStorage.setItem('quoteData', JSON.stringify(quoteState));
            window.location.href = 'liosdoire_preview_v9.html';
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liosdoire Quote v18 â€” ERP Logic</title>
    <link rel="stylesheet" href="style_v16_14.css">
    <style>
        /* v18 Specific Styles */
        .required-star { color: #CF122E; font-weight: bold; margin-left: 3px; }
        input.error { border-color: #CF122E; background-color: #fff5f5; }
        .brand-header { display: flex; align-items: center; justify-content: center; padding-bottom: 20px; border-bottom: 2px solid #e2e8f0; margin-bottom: 20px; }
        .brand-left { text-align: right; padding-right: 20px; border-right: 2px solid #cbd5e1; }
        .brand-name { font-size: 1.4rem; font-weight: bold; color: #333; margin: 0; }
        .brand-status { font-size: 0.8rem; color: #666; margin-top: 4px; font-weight: 500; }
        .brand-right { padding-left: 20px; }
        .ricoh-logo-img { height: 45px; display: block; }
        
        /* Device Options Styling */
        .device-options { display: none; background: #f8fafc; padding: 10px; margin-top: 10px; border-top: 1px dashed #cbd5e1; font-size: 0.85rem; }
        .device-options.active { display: block; }
        .option-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; }
        .option-label { display: flex; align-items: center; gap: 8px; color: #475569; }
        .option-cost { font-weight: bold; color: #64748b; font-size: 0.8rem; }
    </style>
</head>
<body>
    <header>
        <div class="brand-header">
            <div class="brand-left"><div class="brand-name">Liosdoire Computers</div><div class="brand-status">Authorized & Preferred Regional Reseller<br>Co. Kerry</div></div>
            <div class="brand-right"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e9/Ricoh_logo.svg/1280px-Ricoh_logo.svg.png" class="ricoh-logo-img" onerror="this.onerror=null; this.src='https://logo.wine/a/logo/Ricoh/Ricoh-Logo.wine.svg'"></div>
        </div>
        <div style="text-align:center; font-size:0.9rem; color:#CF122E; font-weight:bold; margin-top:10px;">INTERNAL QUOTATION CALCULATOR (v18.0)</div>
    </header>

    <div id="app">
        <div class="section">
            <div class="section-title">1. Client Information</div>
            <div class="client-info-grid">
                <div><label>Business / School Name<span class="required-star">*</span></label><input type="text" id="clientBusiness" placeholder="e.g. St. Brendan's College"></div>
                <div><label>Contact Person Name<span class="required-star">*</span></label><input type="text" id="clientName" placeholder="e.g. John Doe"></div>
                <div><label>Email Address<span class="required-star">*</span></label><input type="email" id="clientEmail" placeholder="admin@school.ie"></div>
                <div><label>Phone Number<span class="required-star">*</span></label><input type="tel" id="clientPhone" placeholder="08x xxx xxxx"></div>
                <div style="grid-column: span 2;"><label>Billing Address<span class="required-star">*</span></label><input type="text" id="clientAddress" placeholder="Street, Town, County, Eircode"></div>
                <div><label>Sector</label><select id="clientSector"><option value="Education">Education</option><option value="Business">Business</option></select></div>
            </div>
        </div>

        <div class="section"><div class="section-title">2. Select Devices & Options</div><div class="device-grid" id="deviceList"></div></div>

        <div class="section"><div class="section-title">3. Managed Services (Per Unit)</div>
            <div style="margin: 16px 0;">
                <label>Select RSI Pack Level:</label>
                <select id="packSelect" style="margin-top: 4px; padding: 8px; font-weight: bold;">
                    <option value="Basic">RSI Basic (Remote Support) â€” â‚¬0.00</option>
                    <option value="Connect">RSI Connect+ (Cloud & Security) â€” â‚¬10.00</option>
                </select>
                <div style="font-size: 0.8rem; color: #64748b; margin-top: 5px;" id="packDesc">Client Cost: â‚¬0 | Internal Cost: â‚¬0</div>
            </div>
            <div id="mpsDeviceContainer" class="mps-list"><div style="padding:15px; color:#64748b; text-align:center;">No devices selected.</div></div>
        </div>

        <div class="section"><div class="section-title">4. Print Credit Dashboard</div>
            <div class="dashboard-container">
                <div class="control-group" style="background:#f8fafc; border-color:#94a3b8;"><span class="tag tag-blue">Hardware Mix</span><div class="col-header">Mono Mix %</div><div class="slider-wrapper"><input type="range" id="sliderBaseMono" class="slider-black" orient="vertical" min="0" max="100" value="75" step="1"></div><div class="display-val" id="dispPctMono">75%</div><input type="text" id="readBaseMono" class="manual-input" readonly style="background:#e2e8f0; color:#64748b;" value="0"></div>
                <div class="control-group" style="background:#f8fafc; border-color:#94a3b8;"><span class="tag tag-blue">Hardware Mix</span><div class="col-header">Colour Mix %</div><div class="slider-wrapper"><input type="range" id="sliderBaseColour" class="slider-rainbow" orient="vertical" min="0" max="100" value="25" step="1"></div><div class="display-val" id="dispPctCol">25%</div><input type="text" id="readBaseColour" class="manual-input" readonly style="background:#e2e8f0; color:#64748b;" value="0"></div>
                <div class="control-group"><span class="tag tag-green">Add-on</span><div class="col-header">Extra Mono</div><div class="slider-wrapper"><input type="range" id="sliderAddonMono" class="slider-black" orient="vertical" min="0" max="1000000" step="1000" value="0"></div><input type="number" id="inputAddonMono" class="manual-input" value="0" step="1000"></div>
                <div class="control-group"><span class="tag tag-green">Add-on</span><div class="col-header">Extra Colour</div><div class="slider-wrapper"><input type="range" id="sliderAddonColour" class="slider-rainbow" orient="vertical" min="0" max="1000000" step="1000" value="0"></div><input type="number" id="inputAddonColour" class="manual-input" value="0" step="1000"></div>
            </div>
            <div style="text-align:center; padding: 10px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px;"><span style="color:#166534; font-weight:bold;">Total Retail Add-on Cost: <span id="addonCostDisplay" style="font-size:1.2rem">+â‚¬0.00</span> / mo</span></div>
            <div class="live-total-box"><span class="live-label">Estimated Monthly Total (Ex VAT)</span><span id="liveMonthlyDisplay" class="live-amount">â‚¬0.00</span></div>
        </div>

        <div class="section"><div class="section-title">5. Finalize Quote</div>
            <div class="action-bar"><button id="calculateBtn" class="success" style="flex:1;">Calculate / Preview Quote</button><label class="action-checkbox"><input type="checkbox" id="showBreakdownChk"> Review Internal Margin & Costs</label></div>
            <div id="result" class="result">
                <h3 style="color:var(--primary); border-bottom:1px solid #cbd5e1; padding-bottom:5px;">Internal Financial Breakdown</h3>
                <table class="result-table"><thead><tr><th>Item</th><th>Logic</th><th>Amount (â‚¬)</th></tr></thead>
                    <tbody>
                        <tr><td>(+) Hardware Lease</td><td><span class="calc-detail">Devices + Options</span></td><td id="deviceAmt"></td></tr>
                        <tr><td>(+) MPS Pack</td><td><span class="calc-detail">Pack Cost Ã— Active Units</span></td><td id="mpsAmt"></td></tr>
                        <tr style="background:#f0fdf4"><td><strong>(+) Retail Add-on</strong></td><td><span class="calc-detail">Extra Pages Revenue / 60</span></td><td id="retailAddonAmt" style="font-weight:bold; color:#166534"></td></tr>
                        <tr style="background:#fdf2f2; border-top: 2px solid #cbd5e1; border-bottom: 2px solid #cbd5e1;"><td><strong>(=) Monthly Revenue</strong></td><td><span class="calc-detail">Sum of above</span></td><td id="totalMonthlyAmt" style="font-weight:bold; color:var(--primary);"></td></tr>
                        <tr style="background:#f8fafc"><td><strong>Total Contract Revenue (60 Mo)</strong></td><td><span class="calc-detail">Monthly Ã— 60</span></td><td id="grossContractAmt" style="font-weight:bold;"></td></tr>
                        <tr><td>(-) Grenke Finance Fee</td><td><span class="calc-detail">Fixed @ 15%</span></td><td id="grenkeAmt" style="color:red"></td></tr>
                        <tr><td>(-) Hardware CapEx</td><td><span class="calc-detail">Devices + Options Cost</span></td><td id="deviceCapexAmt" style="color:red"></td></tr>
                        <tr><td>(-) Service Cost (Ricoh)</td><td><span class="calc-detail">Internal CPP Ã— Vol</span></td><td id="ricohAmt" style="color:red"></td></tr>
                        <tr><td>(-) RSI Pack Cost</td><td><span class="calc-detail">Internal Cost</span></td><td id="rsiCostAmt" style="color:red"></td></tr>
                        <tr style="background:#fdf2f2; border-top: 2px solid #cbd5e1;"><td><strong>(=) Net Cash Profit</strong></td><td><span class="calc-detail">Cash In Bank - Costs</span></td><td id="profitAmt" style="font-weight:bold; font-size:1.1rem; color:var(--success);"></td></tr>
                        <tr><td><strong>Net Margin %</strong></td><td><span class="calc-detail">Profit / Cash In Bank</span></td><td id="marginAmt" style="font-weight:bold"></td></tr>
                    </tbody>
                </table>
                <button id="previewBtn" class="secondary" style="margin-top: 15px; width: 100%;">ðŸ“„ Proceed to Order / Preview</button>
            </div>
        </div>
    </div>

    <script>
        // --- V18 CONSTANTS ---
        const RICOH_CPP = { mono: 0.0035, colour: 0.031 }; 
        const RETAIL_CPP = { mono: 0.005, colour: 0.05 };  
        const MARGIN_TARGET = 0.50; // We target 50% margin
        const GRENKE_COST_FACTOR = 0.15; // Fixed 15% cost of funds
        
        // Service Packs
        const PACKS = {
            "Basic":   { retail: 0.00, cost: 0.00, name: "RSI Basic" },
            "Connect": { retail: 10.00, cost: 9.00, name: "RSI Connect+" }
        };

        // --- CATALOGUE ---
        // Note: Prices (cost) are suggested Retail Monthly. Capex is internal buy price.
        const COMMON_OPTIONS = [
            { id: "opt_cab", name: "Cabinet Stand", retail: 5.00, capex: 150 },
            { id: "opt_tray", name: "Paper Bank (2x550)", retail: 12.00, capex: 350 },
            { id: "opt_fin", name: "Internal Finisher (Staple)", retail: 15.00, capex: 550 }
        ];

        const DEVICES = [
            // COLOUR A3
            { model: "Ricoh IM C2010", desc: "Ricoh IM C2010 (A3 Col 20ppm)", cost: 95.00, capex: 1600, options: COMMON_OPTIONS },
            { model: "Ricoh IM C2510", desc: "Ricoh IM C2510 (A3 Col 25ppm)", cost: 110.00, capex: 1850, options: COMMON_OPTIONS },
            { model: "Ricoh IM C3010", desc: "Ricoh IM C3010 (A3 Col 30ppm)", cost: 150.00, capex: 2000, options: COMMON_OPTIONS },
            { model: "Ricoh IM C3510", desc: "Ricoh IM C3510 (A3 Col 35ppm)", cost: 170.00, capex: 2300, options: COMMON_OPTIONS },
            { model: "Ricoh IM C4510", desc: "Ricoh IM C4510 (A3 Col 45ppm)", cost: 210.00, capex: 3100, options: COMMON_OPTIONS },
            { model: "Ricoh IM C6010", desc: "Ricoh IM C6010 (A3 Col 60ppm)", cost: 280.00, capex: 4500, options: COMMON_OPTIONS },
            
            // MONO A3
            { model: "Ricoh IM 2500", desc: "Ricoh IM 2500 (A3 Mono 25ppm)", cost: 70.00, capex: 1400, options: COMMON_OPTIONS },
            { model: "Ricoh IM 3500", desc: "Ricoh IM 3500 (A3 Mono 35ppm)", cost: 90.00, capex: 1650, options: COMMON_OPTIONS },
            { model: "Ricoh IM 5000", desc: "Ricoh IM 5000 (A3 Mono 50ppm)", cost: 130.00, capex: 2200, options: COMMON_OPTIONS },
            { model: "Ricoh IM 7000", desc: "Ricoh IM 7000 (A3 Mono 70ppm)", cost: 300.00, capex: 4150, options: COMMON_OPTIONS },

            // A4 DESKTOP
            { model: "Ricoh IM C320F", desc: "Ricoh IM C320F (A4 Col Desktop)", cost: 50.00, capex: 1000, options: [] },
            { model: "Ricoh IM 370",   desc: "Ricoh IM 370 (A4 Mono Desktop)", cost: 25.00, capex: 700, options: [] }
        ];

        // --- APP LOGIC ---
        function init() {
            renderDeviceList();

            // Slider Logic
            const sBaseMono = document.getElementById('sliderBaseMono'), sBaseCol = document.getElementById('sliderBaseColour');
            sBaseMono.addEventListener('input', (e) => { sBaseCol.value = 100 - parseInt(e.target.value); updateMix(); });
            sBaseCol.addEventListener('input', (e) => { sBaseMono.value = 100 - parseInt(e.target.value); updateMix(); });

            const ids = [['sliderAddonMono', 'inputAddonMono'], ['sliderAddonColour', 'inputAddonColour']];
            ids.forEach(([sId, iId]) => {
                const s = document.getElementById(sId), i = document.getElementById(iId);
                const sync = () => { updateAddonCost(); calculateAll(); }; 
                s.addEventListener('input', (e) => { i.value = e.target.value; sync(); });
                i.addEventListener('input', (e) => { s.value = e.target.value; sync(); });
            });

            document.getElementById('packSelect').addEventListener('change', updatePackDesc);
            document.getElementById('calculateBtn').addEventListener('click', handleCalculateClick);
            document.getElementById('previewBtn').addEventListener('click', goToPreview);
            
            updatePackDesc();
        }

        function renderDeviceList() {
            const list = document.getElementById('deviceList');
            list.innerHTML = DEVICES.map((d, index) => {
                const safeModel = d.model.replace(/\s+/g, '_');
                
                // Build Options HTML
                let optionsHtml = '';
                if(d.options && d.options.length > 0) {
                    optionsHtml = `<div class="device-options" id="opts-${safeModel}">
                        <div style="font-weight:bold; margin-bottom:5px; color:#CF122E;">Optional Extras:</div>
                        ${d.options.map((opt, oIdx) => `
                            <div class="option-row">
                                <label class="option-label">
                                    <input type="checkbox" class="opt-chk" data-parent="${safeModel}" data-retail="${opt.retail}" data-capex="${opt.capex}" data-name="${opt.name}" onchange="calculateAll()">
                                    ${opt.name}
                                </label>
                                <span class="option-cost">+â‚¬${opt.retail.toFixed(2)}/mo</span>
                            </div>
                        `).join('')}
                    </div>`;
                }

                return `
                <div class="device-item" style="flex-direction:column; align-items:stretch;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div class="device-info">
                            <div class="device-name">${d.desc}</div>
                            <div class="device-financials">Base: â‚¬${d.cost}/mo</div>
                        </div>
                        <div class="qty-controls">
                            <button onclick="adjustQty('${safeModel}', -1)">-</button>
                            <input type="number" id="qty-${safeModel}" value="0" readonly style="width:50px; text-align:center; background:#f1f5f9;">
                            <button onclick="adjustQty('${safeModel}', 1)">+</button>
                        </div>
                    </div>
                    ${optionsHtml}
                </div>`;
            }).join('');
        }

        function updatePackDesc() {
            const val = document.getElementById('packSelect').value;
            const p = PACKS[val];
            document.getElementById('packDesc').textContent = `Client Cost: â‚¬${p.retail.toFixed(2)} | Internal Cost: â‚¬${p.cost.toFixed(2)}`;
            calculateAll();
        }

        function adjustQty(modelSafe, delta) { 
            const el = document.getElementById(`qty-${modelSafe}`);
            const optsDiv = document.getElementById(`opts-${modelSafe}`);
            
            let newQty = Math.max(0, (parseInt(el.value)||0)+delta);
            el.value = newQty;
            
            // Show/Hide options based on Qty
            if(optsDiv) {
                if(newQty > 0) optsDiv.classList.add('active');
                else {
                    optsDiv.classList.remove('active');
                    // Uncheck options if qty goes to 0
                    optsDiv.querySelectorAll('input').forEach(i => i.checked = false);
                }
            }

            renderMpsList(); 
            recalculateBaseCredit(); 
            calculateAll(); 
        }
        
        function getQty(model) { return parseInt(document.getElementById(`qty-${model.replace(/\s+/g, '_')}`).value) || 0; }

        function calculateAll() {
            const data = getFinancials();
            document.getElementById('liveMonthlyDisplay').textContent = `â‚¬${data.totalMonthly.toFixed(2)}`;
            if (data.totalMonthly === 0) return;

            document.getElementById('deviceAmt').textContent = `â‚¬${data.hwMonthly.toFixed(2)}`;
            document.getElementById('mpsAmt').textContent = `â‚¬${data.mpsMonthly.toFixed(2)}`;
            document.getElementById('retailAddonAmt').textContent = `â‚¬${data.addonMonthly.toFixed(2)}`;
            
            document.getElementById('totalMonthlyAmt').textContent = `â‚¬${data.totalMonthly.toFixed(2)}`;
            document.getElementById('grossContractAmt').textContent = `â‚¬${data.grossContractVal.toFixed(2)}`;
            
            document.getElementById('grenkeAmt').textContent = `-â‚¬${data.grenkeFee.toFixed(2)}`;
            document.getElementById('deviceCapexAmt').textContent = `-â‚¬${data.totalCapex.toFixed(2)}`;
            document.getElementById('ricohAmt').textContent = `-â‚¬${data.serviceCost.toFixed(2)}`;
            document.getElementById('rsiCostAmt').textContent = `-â‚¬${data.rsiInternalCost.toFixed(2)}`;
            
            document.getElementById('profitAmt').textContent = `â‚¬${data.netProfit.toFixed(2)}`;
            document.getElementById('marginAmt').textContent = `${data.margin.toFixed(1)}%`;
            
            saveState(data);
        }

        function getFinancials() {
            let hwMonthly = 0, totalCapex = 0;
            
            // 1. Hardware & Options
            DEVICES.forEach(d => {
                const qty = getQty(d.model);
                if(qty > 0) { 
                    const safeModel = d.model.replace(/\s+/g, '_');
                    // Base Device
                    hwMonthly += qty * d.cost; 
                    totalCapex += qty * d.capex; 
                    
                    // Options
                    const optsDiv = document.getElementById(`opts-${safeModel}`);
                    if(optsDiv) {
                        optsDiv.querySelectorAll('input:checked').forEach(opt => {
                            // Logic: Option Price * Device Qty (Assuming all units get the option if selected)
                            // Or is option per unit? The UI is simple, so checking the box applies to ALL units of that model.
                            hwMonthly += (parseFloat(opt.dataset.retail) * qty);
                            totalCapex += (parseFloat(opt.dataset.capex) * qty);
                        });
                    }
                }
            });

            // 2. Managed Services (RSI Packs)
            let mpsMonthly = 0, rsiInternalCost = 0, mpsCount = 0;
            const packKey = document.getElementById('packSelect').value;
            const packData = PACKS[packKey];
            
            // Iterate checked MPS units
            document.querySelectorAll('[id^="mps-chk-"]').forEach(chk => { 
                if(chk.checked) { 
                    mpsMonthly += packData.retail; 
                    rsiInternalCost += packData.cost;
                    mpsCount++; 
                } 
            });
            // rsiInternalCost is Monthly cost, so over 60 months? No, calculation is usually Profit = (MonthlyRev - MonthlyCost) * 60 - Capex. 
            // BUT current logic calculates Net Profit on CASH basis.
            // Cash In = (MonthlyRev * 60) - GrenkeFee.
            // Costs = Capex + (ServiceCost * 60) + (RsiCost * 60).
            const rsiTotalCost = rsiInternalCost * 60;

            // 3. Add-ons
            const addMono = parseInt(document.getElementById('inputAddonMono').value) || 0;
            const addCol = parseInt(document.getElementById('inputAddonColour').value) || 0;
            const addonRevenueTotal = (addMono * RETAIL_CPP.mono) + (addCol * RETAIL_CPP.colour);
            const addonMonthly = addonRevenueTotal / 60;

            // 4. Totals
            const totalMonthly = hwMonthly + mpsMonthly + addonMonthly;
            const grossContractVal = totalMonthly * 60;
            const grenkeFee = grossContractVal * GRENKE_COST_FACTOR; // Fixed 15%
            const cashInBank = grossContractVal - grenkeFee;

            // 5. Service Costs
            const baseMono = parseInt(document.getElementById('readBaseMono').value.replace(/,/g, '')) || 0;
            const baseCol = parseInt(document.getElementById('readBaseColour').value.replace(/,/g, '')) || 0;
            const serviceCost = ((baseMono + addMono) * RICOH_CPP.mono) + ((baseCol + addCol) * RICOH_CPP.colour);
            
            // 6. Profit
            const netProfit = cashInBank - totalCapex - serviceCost - rsiTotalCost;
            const margin = (netProfit / (cashInBank || 1)) * 100;
            
            return { 
                hwMonthly, mpsMonthly, addonMonthly, totalMonthly, 
                grossContractVal, grenkeFee, totalCapex, 
                serviceCost, rsiInternalCost: rsiTotalCost, 
                netProfit, margin,
                baseMono, baseCol, addMono, addCol, mpsCount 
            };
        }

        // --- HELPERS ---
        function updateMix() { const sBaseMono = document.getElementById('sliderBaseMono'); const sBaseCol = document.getElementById('sliderBaseColour'); document.getElementById('dispPctMono').textContent = sBaseMono.value + '%'; document.getElementById('dispPctCol').textContent = sBaseCol.value + '%'; recalculateBaseCredit(); calculateAll(); }
        function updateAddonCost() { const m = parseInt(document.getElementById('inputAddonMono').value)||0; const c = parseInt(document.getElementById('inputAddonColour').value)||0; const val = (m*RETAIL_CPP.mono)+(c*RETAIL_CPP.colour); document.getElementById('addonCostDisplay').textContent = `+â‚¬${(val/60).toFixed(2)}`; }
        
        function handleCalculateClick() {
            const fields = ['clientBusiness', 'clientName', 'clientEmail', 'clientPhone', 'clientAddress'];
            let isValid = true;
            fields.forEach(id => {
                const el = document.getElementById(id);
                if(!el.value.trim()) { el.classList.add('error'); isValid = false; } 
                else { el.classList.remove('error'); }
            });
            if(!isValid) { alert("Please fill in all mandatory fields."); return; }
            calculateAll();
            document.getElementById('showBreakdownChk').checked ? document.getElementById('result').classList.add('visible') : goToPreview();
        }

        function recalculateBaseCredit() { 
            let safeBudget = 0;
            DEVICES.forEach(d => { 
                const q = getQty(d.model); 
                if(q>0) { 
                    // Calculate "Safe Budget" for toner based on Hardware Revenue
                    // We remove Capex and Target Margin to see what's left for toner.
                    // Note: We ignore Option revenue for toner calculation to keep it simple/safe.
                    const rev = d.cost * 60; 
                    const safe = Math.max(0, rev - d.capex - (rev * MARGIN_TARGET)); 
                    safeBudget += safe * q; 
                } 
            });
            const mPct = parseInt(document.getElementById('sliderBaseMono').value)/100;
            const cPct = parseInt(document.getElementById('sliderBaseColour').value)/100;
            const cost = (mPct * RICOH_CPP.mono) + (cPct * RICOH_CPP.colour);
            
            if(cost===0 || safeBudget===0) { document.getElementById('readBaseMono').value=0; document.getElementById('readBaseColour').value=0; return; }
            
            const total = Math.floor(safeBudget/cost);
            document.getElementById('readBaseMono').value = Math.floor(total*mPct).toLocaleString();
            document.getElementById('readBaseColour').value = Math.floor(total*cPct).toLocaleString();
        }

        function renderMpsList() { 
            const container = document.getElementById('mpsDeviceContainer');
            // Save state of checkboxes
            const checkedStates = {};
            container.querySelectorAll('input[type="checkbox"]').forEach(c => checkedStates[c.id] = c.checked);
            const locationStates = {};
            container.querySelectorAll('input[type="text"]').forEach(c => locationStates[c.id] = c.value);

            let html = "";
            DEVICES.forEach(d => {
                const qty = getQty(d.model);
                if (qty > 0) {
                    const safeModel = d.model.replace(/\s+/g, '_');
                    for (let i = 1; i <= qty; i++) {
                        const chkId = `mps-chk-${safeModel}-${i}`;
                        const locId = `mps-loc-${safeModel}-${i}`;
                        const isChecked = checkedStates[chkId] !== undefined ? checkedStates[chkId] : false; // Default off?
                        
                        html += `
                        <div class="mps-item">
                            <div class="mps-row-main">
                                <input type="checkbox" id="${chkId}" data-model="${d.model}" ${isChecked ? 'checked' : ''} onchange="calculateAll();">
                                <label for="${chkId}"><span>${d.model}</span><span class="mps-unit-badge">Unit #${i}</span></label>
                            </div>
                            <div class="mps-location-input" style="display:block !important; margin-top:8px; margin-left:35px;">
                                <input type="text" id="${locId}" placeholder="Location / Name" value="${locationStates[locId] || ''}">
                            </div>
                        </div>`;
                    }
                }
            });
            container.innerHTML = html || '<div style="padding:15px; color:#64748b; text-align:center;">No devices selected.</div>';
        }

        function saveState(data) {
            // Collect Hardware + Options for preview
            const finalDeviceList = [];
            document.querySelectorAll('[id^="mps-chk-"]').forEach(chk => {
                const parts = chk.id.split('-');
                const unitNum = parts.pop();
                const model = chk.dataset.model;
                const safeModel = model.replace(/\s+/g, '_');
                const locInput = document.getElementById(chk.id.replace('mps-chk-', 'mps-loc-'));
                
                // Get options for this model
                const selectedOptions = [];
                const optsDiv = document.getElementById(`opts-${safeModel}`);
                if(optsDiv) {
                    optsDiv.querySelectorAll('input:checked').forEach(opt => selectedOptions.push(opt.dataset.name));
                }

                finalDeviceList.push({
                    model: model,
                    unitNum: unitNum,
                    isManaged: chk.checked, // True if pack selected
                    location: locInput && locInput.value.trim() ? locInput.value.trim() : `Unit #${unitNum}`,
                    options: selectedOptions
                });
            });

            quoteState = {
                clientBusiness: document.getElementById('clientBusiness').value,
                clientName: document.getElementById('clientName').value,
                clientEmail: document.getElementById('clientEmail').value,
                clientPhone: document.getElementById('clientPhone').value,
                clientAddress: document.getElementById('clientAddress').value,
                clientSector: document.getElementById('clientSector').value,
                date: new Date().toLocaleDateString('en-IE'),
                finalDeviceList, 
                baseMono: data.baseMono, baseCol: data.baseCol,
                addMono: data.addMono, addCol: data.addCol,
                monthlyExVat: data.totalMonthly.toFixed(2),
                monthlyIncVat: (data.totalMonthly*1.23).toFixed(2),
                packName: PACKS[document.getElementById('packSelect').value].name,
                financials: {
                    netProfit: data.netProfit.toFixed(2),
                    margin: data.margin.toFixed(1) + "%",
                    capex: data.totalCapex.toFixed(2)
                }
            };
        }

        function goToPreview() {
            if (!quoteState) calculateAll();
            if (parseFloat(quoteState.monthlyExVat) === 0) { alert("Please select at least one device."); return; }
            sessionStorage.setItem('quoteData', JSON.stringify(quoteState));
            window.location.href = 'liosdoire_preview_v18.html';
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
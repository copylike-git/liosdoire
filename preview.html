<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liosdoire â€” Quote Preview</title>
    <style>
        * { box-sizing: border-box; font-family: Arial, sans-serif; }
        body { padding: 20px; max-width: 800px; margin: 0 auto; background: #f8fafc; }
        .page { background: white; padding: 40px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #1e3a8a; margin-bottom: 30px; }
        .header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .section { margin-bottom: 25px; }
        .section-title { font-weight: bold; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { text-align: left; padding: 8px; border-bottom: 1px solid #e2e8f0; }
        .signature-area { 
            border: 2px dashed #94a3b8; 
            height: 150px; 
            margin: 20px 0; 
            background: #f1f5f9;
            position: relative;
        }
        #signatureCanvas { 
            width: 100%; 
            height: 100%; 
            cursor: crosshair; 
        }
        .btn { 
            background: #1e3a8a; 
            color: white; 
            border: none; 
            padding: 14px 28px; 
            font-size: 18px; 
            border-radius: 6px; 
            cursor: pointer; 
            display: block; 
            margin: 30px auto; 
        }
        .btn:hover { background: #1e3a8a; opacity: 0.9; }
        @media print { 
            .btn, .signature-instructions { display: none; }
            body { background: white; }
        }
    </style>
</head>
<body>
    <div class="page">
        <h1>Liosdoire MPS Quote â€” Approval</h1>
        
        <div class="header">
            <div>
                <strong>Client:</strong> <span id="previewClientName">â€”</span><br>
                <strong>Date:</strong> <span id="previewDate">â€”</span>
            </div>
            <div>
                <strong>Sector:</strong> <span id="previewSector">â€”</span>
            </div>
        </div>

        <div class="section">
            <div class="section-title">Selected Devices</div>
            <table>
                <thead>
                    <tr>
                        <th>Qty</th>
                        <th>Model</th>
                        <th>Monthly Cost</th>
                    </tr>
                </thead>
                <tbody id="previewDeviceTable">
                    <!-- Filled by JS -->
                </tbody>
            </table>
        </div>

        <div class="section">
            <div class="section-title">Print Agreement</div>
            <p>â€¢ Print Credit: <span id="previewMonoCredit">â€”</span> mono + <span id="previewColourCredit">â€”</span> colour (60 months)</p>
            <p>â€¢ Cloud Print Management: â‚¬20/machine/month</p>
            <p>â€¢ Excess: â‚¬0.005 mono / â‚¬0.05 colour</p>
            <p>â€¢ All prices ex. VAT (23%)</p>
        </div>

        <div class="section">
            <div class="section-title">Financial Summary</div>
            <p><strong>Monthly Total (ex. VAT):</strong> â‚¬<span id="previewMonthlyExVat">â€”</span></p>
            <p><strong>Monthly Total (inc. VAT):</strong> â‚¬<span id="previewMonthlyIncVat">â€”</span></p>
            <p><strong>Compliance:</strong> <span id="previewCompliance" style="color: green;">PASS</span></p>
        </div>

        <div class="section">
            <div class="section-title">Client Approval</div>
            <div class="signature-instructions">
                <p>Please sign below to approve this quotation:</p>
            </div>
            <div class="signature-area">
                <canvas id="signatureCanvas"></canvas>
            </div>
            <button id="clearBtn" style="background:#64748b; padding:8px 16px; font-size:14px;">Clear Signature</button>
        </div>

        <button id="confirmBtn" class="btn">âœ… Confirm & Save for Order</button>
    </div>

    <script>
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const data = JSON.parse(sessionStorage.getItem('quoteData'));
            if (!data) {
                alert("No quote data found. Please recalculate.");
                window.history.back();
                return;
            }

            // Populate preview
            document.getElementById('previewClientName').textContent = data.clientName;
            document.getElementById('previewDate').textContent = data.date;
            document.getElementById('previewSector').textContent = data.clientSector;
            document.getElementById('previewMonoCredit').textContent = data.monoCredit.toLocaleString();
            document.getElementById('previewColourCredit').textContent = data.colourCredit.toLocaleString();
            document.getElementById('previewMonthlyExVat').textContent = data.totalMonthlyExVat.toFixed(2);
            document.getElementById('previewMonthlyIncVat').textContent = (data.totalMonthlyExVat * 1.23).toFixed(2);
            document.getElementById('previewCompliance').textContent = data.compliance;
            document.getElementById('previewCompliance').style.color = data.compliance === 'PASS' ? 'green' : 'orange';

            // Devices
            const table = document.getElementById('previewDeviceTable');
            for (const [model, qty] of Object.entries(data.quantities)) {
                if (qty > 0) {
                    const row = table.insertRow();
                    row.innerHTML = `<td>${qty}</td><td>${model}</td><td>â‚¬${(qty * getDeviceCost(model)).toFixed(2)}</td>`;
                }
            }

            // Signature pad
            const canvas = document.getElementById('signatureCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#1e3a8a';

            let isDrawing = false;
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch support for tablets
            canvas.addEventListener('touchstart', e => { e.preventDefault(); startDrawing(e.touches[0]); });
            canvas.addEventListener('touchmove', e => { e.preventDefault(); draw(e.touches[0]); });
            canvas.addEventListener('touchend', stopDrawing);

            function getPos(e) {
                const rect = canvas.getBoundingClientRect();
                return {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            }

            function startDrawing(e) {
                isDrawing = true;
                const pos = getPos(e);
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
            }

            function draw(e) {
                if (!isDrawing) return;
                const pos = getPos(e);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            }

            function stopDrawing() {
                isDrawing = false;
            }

            document.getElementById('clearBtn').addEventListener('click', () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            });

            // Confirm button
            document.getElementById('confirmBtn').addEventListener('click', () => {
                if (isCanvasEmpty()) {
                    alert("âš ï¸ Please add client signature before confirming.");
                    return;
                }
                
                // Prompt to screenshot
                alert("ðŸ“¸ Please take a screenshot now for order confirmation.\n\nOn iPad: Press Side + Volume Up\nOn Android: Power + Volume Down");
                
                // Optional: Save quote to server (add later if needed)
                // sendToServer(data);
            });

            function isCanvasEmpty() {
                const pixels = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                return pixels.every(p => p === 0);
            }
        });
        
        // Device monthly costs (match your v7_internal)
        function getDeviceCost(model) {
            const costs = {
                "Ricoh IM 7000": 300.00,
                "Ricoh IM C3010": 150.00,
                "Ricoh IM 3000": 100.00,
                "Ricoh IM C320F": 50.00,
                "Ricoh IM 370": 25.00
            };
            return costs[model] || 0;
        }
    </script>
</body>
</html>